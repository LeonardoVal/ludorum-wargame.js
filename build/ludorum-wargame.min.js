//! ludorum-wargame 0.0.1

(function(a){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","ludorum"],a):"object"==typeof exports&&module.exports?module.exports=a(require("creatartis-base"),require("sermat"),require("ludorum")):this.Sermat=a(this.base,this.Sermat,this.ludorum)}).call(this,function a(b,c,d){"use strict";function e(a,b){return b.priority=a,b}var f=b.declare,g=b.iterable,h=b.Iterable,i=b.initialize,j=b.raiseIf,k=b.obj,l={__package__:"ludorum-wargame",__name__:"ludorum_wargame",__init__:a,__dependencies__:[b,c,d],__SERMAT__:{include:[b]}},m=l.Army=f({constructor:function(a){var b=this;i(this,a).string("player",{ignore:!0}).number("score",{coerce:!0,defaultValue:0}).array("units"),this.units&&this.units.forEach(function(a,c){a.id=b.player+"#"+c,a.army=b})},isEnabled:function(){for(var a=0,b=this.units.length;a<b;a++)if(this.units[a].isEnabled)return!0;return!1},startRound:function(){return this.units.filter(function(a){return a.startRound()}).length},actions:function(a){var b=a.activeUnit();return b?b.getActions(a):this.units.filter(function(a){return a.isEnabled}).map(function(a){return new q(a.id)})},isEliminated:function(a){return this.units.filter(function(a){return!a.isDead()}).length<=0},livingUnits:function(){return this.units.filter(function(a){return!a.isDead()})},worth:function(){return g(this.units).map(function(a){return a.worth()}).sum()},"static __SERMAT__":{serializer:function(a){return[{player:a.player,units:a.units,score:a.score}]}}}),n=l.Unit=f({radius:.5,quality:3,defense:4,constructor:function(a){i(this,a).array("position").array("models").bool("isActive",{ignore:!0}).bool("hasMoved",{ignore:!0}).bool("isEnabled",{ignore:!0}),this.position=new Float32Array(this.position)},cost:function(){return g(this.models).map(function(a){return a.cost||0}).sum()},size:function(){return this.models.length},livingModels:function(){return this.models.filter(function(a){return a.health()>0})},health:function(){return this.livingModels().length},isDead:function(){return this.health()<=0},worth:function(){return g(this.models).map(function(a){return a.health()/a.toughness*a.cost}).sum()},getActions:function(a){var b=[new r(this.id)];return this.isActive&&(this.hasMoved||(b=b.concat(this.getMoveActions(a))),b=b.concat(this.getShootActions(a))),b},maxRange:function(){var a=-(1/0);return this.livingModels().forEach(function(b){b.equipments.forEach(function(b){+b.range>a&&(a=+b.range)})}),a},getShootActions:function(a){var b=a.armies[a.opponent()].units,c=this,d=this.maxRange()||0,e=b.filter(function(b){return a.terrain.canShoot(c,b,d,a)!=1/0}).map(function(a){return new t(c.id,a.id)});return e},getMoveActions:function(a){var b=this;return g(a.terrain.reachablePositions(b)).mapApply(function(a,c){var d=a.split(",");return new s(b.id,[+d[0],+d[1]],c>6)}).toArray()},startRound:function(){return this.isActive=!1,this.hasMoved=!1,this.isEnabled=this.health()>0,this.isEnabled},activate:function(a){j(!this.isEnabled,"Unit ",this.id," is not enabled!"),j(this.isActive,"Unit ",this.id," is already active!"),j(this.health()<=0,"Unit ",this.id," has been eliminated!"),this.isActive=!0,a.__activeUnit__=this},endTurn:function(a){this.isActive=!1,this.isEnabled=!1,a.__activeUnit__===this&&(a.__activeUnit__=null)},move:function(a,b,c){j(!this.isActive,"Unit ",this.id," is not active!"),this.position=b,this.hasMoved=!0,c&&this.endTurn(a)},suffer:function(a,b){var c,d,e,f=this.models;for(e=0;b>0&&e<f.length&&(c=f[e],d=c.health(),!(d>0&&(c.wounds+=Math.min(b,d),b-=d,b<=0)));e++);return this.isEnabled=this.isEnabled&&!this.isDead(),this.isEnabled},influence:function(a){},"static __SERMAT__":{serializer:function(a){var b={position:[a.position[0],a.position[1]],models:a.models};return["isActive","hasMoved","isEnabled"].forEach(function(c){a.hasOwnProperty(c)&&(b[c]=a[c])}),[b]}}}),o=l.Model=f({toughness:1,equipments:[],constructor:function(a){this.wounds=0|a},health:function(){return this.toughness-this.wounds},shooting:function(a){return a=a||1,equipments.filter(function(b){return b.range>=a})},melee:function(){return equipments.filter(function(a){return a.range<1})},"static __SERMAT__":{serializer:function(a){return[a.wounds]}}}),p=l.GameAction=f({aleatories:function(a){return null},execute:b.objects.unimplemented("GameAction","execute(game, haps)"),unitById:function(a,b){b=b||this.unitId;for(var c=null,d=0;!c&&d<a.players.length;d++)for(var e=a.armies[a.players[d]].units,f=0;f<e.length;f++)if(e[f].id==b){c=e[f];break}return j(!c,"Unit ",b," was not found!"),c},worth:function(){return 0}}),q=l.ActivateAction=f(p,{constructor:function(a){this.unitId=a},execute:function(a){this.unitById(a).activate(a)},"static __SERMAT__":{identifier:"ActivateAction",serializer:function(a){return[a.unitId]}}}),r=l.EndTurnAction=f(p,{constructor:function(a){this.unitId=a},execute:function(a){this.unitById(a).endTurn(a)},"static __SERMAT__":{identifier:"EndTurnAction",serializer:function(a){return[a.unitId]}}}),s=l.MoveAction=f(p,{constructor:function(a,b,c){this.unitId=a,this.position=b,this.run=c},execute:function(a){this.unitById(a).move(a,this.position,this.run)},"static __SERMAT__":{identifier:"MoveAction",serializer:function(a){return[a.unitId,Array.apply(Array,a.position),a.run]}}}),t=l.ShootAction=f(p,{constructor:function(a,b){this.unitId=a,this.targetId=b},aleatories:function(a){var b=this.unitById(a),c=this.unitById(a,this.targetId),d=a.terrain.canSee(b,c),e=0;b.models.forEach(function(a){a.equipments.forEach(function(a){a.range>=d&&(e+=a.attacks)})});var f=new y(b.quality,c.defense,e);return{wounds:f}},execute:function(a,b){var c=b.wounds,d=this.unitById(a,this.targetId);if(c>0){var e=d.worth();d.suffer(a,c),this.worth=e-d.worth()}this.unitById(a,this.unitId).endTurn(a)},"static __SERMAT__":{identifier:"ShootAction",serializer:function(a){return[a.unitId,a.targetId]}}}),u=l.AssaultAction=f(p,{constructor:function(a,b){this.unitId=a,this.targetId=b},aleatories:function(a){return null},execute:function(a,b){var c=0,d=b.wounds,e=this.unitById(a,this.targetId);d>0&&e.suffer(a,d);var f=this.unitById(a,this.unitId);f.disable(a),this.worth=0;var g=e.cost();e.isDead(a)&&(this.worth+=g),this.worth+=g*d/e.size(),f.isDead(a)&&(this.worth-=f.cost()),this.worth-=f.cost()*c/f.size()},"static __SERMAT__":{identifier:"AssaultAction",serializer:function(a){return[unitId,targetId]}}}),v=b.math.combinations,w=l.rolls=function(a,b){return b<=0?[1]:h.range(b+1).map(function(c){return Math.pow(a,c)*Math.pow(1-a,b-c)*v(b,c)}).toArray()},x=l.rerolls=function(a,b){var c=h.repeat(0,b.length).toArray();return b.forEach(function(b,d){0===d?c[0]+=b:w(a,d).forEach(function(a,d){c[d]+=b*a})}),c},y=(l.addRolls=function(a,b){var c=a.length,d=b.length;return h.range(c+d-1).map(function(e){return h.range(e+1).filter(function(a){return a<c&&e-a<d},function(c){return a[c]*b[e-c]}).sum()}).toArray()},l.ShootAleatory=f(d.aleatories.Aleatory,{constructor:function(a,b,c){this.shooterQuality=0|a,this.targetDefense=0|b,this.attackCount=0|c,this.__hitProb__=Math.max(0,Math.min(1,(6-a+1)/6)),this.__saveProb__=Math.max(0,Math.min(1,(6-b+1)/6));var d=x(this.__saveProb__,w(this.__hitProb__,c));this.__distribution__=g(d).map(function(a,b){return[b,a]}).toArray()},distribution:function(){return g(this.__distribution__)},value:function(a){return(a||b.Randomness.DEFAULT).weightedChoice(this.__distribution__)},"static __SERMAT__":{identifier:"ShootAleatory",serializer:function(a){return[a.shooterQuality,a.targetDefense,a.attackCount]}}})),z=l.Wargame=f(d.Game,{name:"Wargame",players:["Red","Blue"],rounds:10,constructor:function(a){d.Game.call(this,a.activePlayer||this.players[0]),i(this,a).object("armies").object("terrain").integer("round",{coerce:!0,defaultValue:-1}).number("rounds",{coerce:!0,ignore:!0}).object("__activeUnit__",{ignore:!0}),this.round<0?this.nextRound():this.nextTurn()},nextTurn:function(){var a=this.activePlayer();if(!this.armies[a].isEnabled()){var b=(this.players.indexOf(a)+1)%this.players.length;this.activePlayers=[this.players[b]],b||this.nextRound()}return this},nextRound:function(){this.round++;var a=this.armies;for(var b in a)a[b].startRound();return this},scores:function(){return g(this.armies).mapApply(function(a,b){return[a,b.worth()]}).toObject()},result:function(){var a=this.players[0],b=this.players[1];if(this.armies[a].isEliminated(this)||this.armies[b].isEliminated(this)||this.round>=this.rounds){var c=this.scores();return this.zerosumResult(c[a]-c[b],a)}return null},synchronizeMetagame:function(){this.terrain.resetTerrain(this)},activeUnit:function(){return this.__activeUnit__},moves:function(){if(!this.result()){this.synchronizeMetagame();var a=this.activePlayer();return k(a,this.armies[a].actions(this))}return null},next:function(a,b,e){var f=this.activePlayer(),g=a[f];j(!g,"Active player ",f," has no actions!");var h=g.aleatories(this);if(j(!h&&b,"Unexpected haps! ",b),h&&!b)return new d.Contingent(this,a,h,e);var i=e?this:c.sermat(this);return g.execute(i,b),i.nextTurn()},"static __SERMAT__":{serializer:function(a){var b={armies:a.armies,terrain:a.terrain,round:a.round,rounds:a.rounds};return a.__activeUnit__&&(b.__activeUnit__=a.__activeUnit__),[b]}}}),A=l.Terrain=f({SURROUNDINGS:[{dx:-1,dy:-1,cost:Math.SQRT2},{dx:-1,dy:0,cost:1},{dx:-1,dy:1,cost:Math.SQRT2},{dx:0,dy:-1,cost:1},{dx:0,dy:1,cost:1},{dx:1,dy:-1,cost:Math.SQRT2},{dx:1,dy:0,cost:1},{dx:1,dy:1,cost:Math.SQRT2}],tileSet:[{passable:!0,visible:!0},{passable:!1,visible:!1}],map:["000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000001000000001111111100000000000000000","000000000000000000000000000000000000000000000000","111111000011111111111001111111111111111111111100","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","111111110011111111111001111111111111111111111100","111111000011111111111001111111111111111111111100","100000000011111111111001111111111111111111111100","100000000111111111111001111111111111111111111100","100111001111111111111001111111111111111111111100","100110000111111111111001111111111111111111111100","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000001000000000000000000000000000000000","000000000000001000000000000000000000000000000000","000000000000001000000001111111100000000000000000","000000000000001000000000000000000000000000000000","000000000000001000000000000000000000000000000000","000000000000001000000000000000000000000000000000","000001111111111111111111111100000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","111111000011111111111001111111111111111111111100","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000"].map(function(a){return new Uint8Array(a.split(""))}),__unitsByPosition__:{},constructor:function(a){this.width=this.map.length,this.height=this.map[0].length},resetTerrain:function(a){this.__unitsByPosition__=this.unitsByPosition(a)},unitsByPosition:function(a){var b=a.armies,c={};for(var d in b)b[d].units.forEach(function(a){a.isDead()||(c[a.position]=a)});return c},tileAt:function(a){var b=this.map[a[0]]&&this.map[a[0]][a[1]];return this.tileSet[b]},isPassable:function(a,b){var c=this.tileAt(a);return!(!c||!c.passable||b&&this.__unitsByPosition__.hasOwnProperty(a))},isVisible:function(a,b){var c=this.tileAt(a);return!(!c||!c.visible||b&&this.__unitsByPosition__.hasOwnProperty(a))},reachablePositions:function(a,b){b=b||12;var c,d,e,f,g,h={},i=[a.position],j=(this.width,this.height,this.SURROUNDINGS);h[a.position]=0;for(var k=0;k<i.length;k++){c=i[k],e=h[c];for(var l=0;l<j.length;l++)g=j[l],f=e+g.cost,f>b||(d=[c[0]+g.dx,c[1]+g.dy],!h.hasOwnProperty(d)&&this.isPassable(d,!0)&&(h[d]=f,i.push(d)))}return h},"dual bresenham":function(a,b,c){c=c||1/0;for(var d,e=[],f=Math.abs(b[0]-a[0]),g=Math.abs(b[1]-a[1]),h=a[0]<b[0]?1:-1,i=a[1]<b[1]?1:-1,j=a.slice(),k=f-g;c--&&(e.push(j.slice()),j[0]!==b[0]||j[1]!==b[1]);)d=2*k,d>-g&&(k-=g,j[0]+=h),d<f&&(k+=f,j[1]+=i);return e},canShoot:function(a,b){if(a.army!==b.army)return 1/0;var c=c(a.position,b.position);if(c>a.maxRange())return 1/0;for(var d,e=this.bresenham(a.position,b.position,c),f=0;f<e.length;f++)if(d=e[f],!this.isVisible(d)||this.__unitsByPosition__[d]&&this.__unitsByPosition__[d]!==b)return 1/0;return c},areaOfSight:function(a,b){b=b||1/0;var c=a.position,d=this,e={};return g(this.BRESENHAM_CACHE).forEachApply(function(a,f){for(var g,h=1;h<f.length&&h<=b&&(g=f[h],g=[c[0]+g[0],c[1]+g[1]],d.isVisible(g))&&(e[g]=h,!d.__unitsByPosition__[g]);h++);}),e},"static __SERMAT__":{serializer:function(a){return[]}}});A.BRESENHAM_CACHE=A.prototype.BRESENHAM_CACHE=function(a){for(var b={radius:a},c=-a;c<=a;c++)b[[c,-a]]=A.bresenham([0,0],[c,-a]),b[[c,+a]]=A.bresenham([0,0],[c,+a]),c!==-a&&c!==a&&(b[[-a,c]]=A.bresenham([0,0],[-a,c]),b[[+a,c]]=A.bresenham([0,0],[+a,c]));return b}(50);l.InfluenceMap=f({momentum:.67,decay:.21,iterations:5,constructor:function(a,b){this.grid=a.terrain.terrainGrid(),this.role=b},update:function(a){var b=this.grid;this.unitsInfluences(a);for(var c=0;c<this.iterations;c++)b=this.spread(b);return b},unitsInfluences:function(a){var b,c,d,e=this,f=this.grid;for(var g in a.armies)b=g===this.role?1:-1,a.armies[g].units.forEach(function(a){a.isDead()||(c=0|a.position[0],d=0|a.position[1],f[c]?f[c][d]||(f[c][d]=0):(f[c]=[],f[c][d]=0),f[c][d]=e.influence(a)*b)})},influence:function(a){return a.worth()},getMomentumInf:function(a,b,c,d){var e,f,g,h,i,j=0;for(f=-1;f<2;f++)for(g=-1;g<2;g++)(0!==f||0!==g)&&a[b+f]&&(e=a[b+f][c+g])&&(e*=d[f*f+g*g],h=j<0?-j:j,i=e<0?-e:e,h<i&&(j=e));return j},spread:function(a){for(var b,c,d=this.decay,e=[NaN,Math.exp(-1*d),Math.exp(-Math.SQRT2*d)],f=this.momentum,g=[],h=0;h<a.length;h++)for(var i=0;i<a[h].length;i++)b=a[h][i],isNaN(b)?(g[h]=g[h]?g[h]:[],g[h][i]="t"):(c=this.getMomentumInf(a,h,i,e),g[h]=g[h]?g[h]:[],g[h][i]=b*(1-f)+c*f);return g}});l.test={example0:function(){var a=new A,b=B.BattleBrothers,c=new z({terrain:a,armies:{Red:new B.BattleBrothers({player:"Red",units:[[3,10]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})}),Blue:new B.BattleBrothers({player:"Blue",units:[[40,10],[40,20],[40,15],[40,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})})}});return c},example1:function(){var a=new A,b=B.BattleBrothers,c=new z({terrain:a,armies:{Red:new B.BattleBrothers({player:"Red",units:[[3,10],[3,20],[4,15],[3,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})}),Blue:new B.BattleBrothers({player:"Blue",units:[[40,10],[40,20],[40,15],[40,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})})}});return c},exampleDS1:function(){var a=new A([{type:p2.Shape.CIRCLE,radius:2,x:12,y:24},{type:p2.Shape.CIRCLE,radius:2,x:12,y:10},{type:p2.Shape.CIRCLE,radius:2,x:12,y:15},{type:p2.Shape.CIRCLE,radius:2,x:12,y:6},{type:p2.Shape.CIRCLE,radius:2,x:12,y:1},{type:p2.Shape.CIRCLE,radius:2,x:12,y:3},{type:p2.Shape.CIRCLE,radius:2,x:12,y:5}]),b=B.BattleBrothers,c=new z({terrain:a,armies:{Red:new B.BattleBrothers({player:"Red",units:[[3,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})}),Blue:new B.BattleBrothers({player:"Blue",units:[[3,4]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})})}});return c},exampleDS2:function(){var a=new A([{type:p2.Shape.CIRCLE,radius:2,x:12,y:24},{type:p2.Shape.CIRCLE,radius:2,x:12,y:10},{type:p2.Shape.CIRCLE,radius:2,x:12,y:15},{type:p2.Shape.CIRCLE,radius:2,x:12,y:6},{type:p2.Shape.CIRCLE,radius:2,x:12,y:1},{type:p2.Shape.CIRCLE,radius:2,x:12,y:3},{type:p2.Shape.CIRCLE,radius:2,x:12,y:5}]),b=B.BattleBrothers,c=new z({terrain:a,armies:{Red:new B.BattleBrothers({player:"Red",units:[[3,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})}),Blue:new B.BattleBrothers({player:"Blue",units:[new b.UNITS.BattleBrothers_Unit({position:[3,4],models:[new b.MODELS.BattleBrother(1),new b.MODELS.BattleBrother,new b.MODELS.BattleBrother,new b.MODELS.BattleBrother,new b.MODELS.BattleBrother]})]})}});return c},exampleDS3:function(){var a=new A([{type:p2.Shape.CIRCLE,radius:2,x:12,y:24},{type:p2.Shape.CIRCLE,radius:2,x:12,y:10},{type:p2.Shape.CIRCLE,radius:2,x:12,y:15},{type:p2.Shape.CIRCLE,radius:2,x:12,y:6},{type:p2.Shape.CIRCLE,radius:2,x:12,y:1},{type:p2.Shape.CIRCLE,radius:2,x:12,y:3},{type:p2.Shape.CIRCLE,radius:2,x:12,y:5}]),b=B.BattleBrothers,c=new z({terrain:a,armies:{Red:new B.BattleBrothers({player:"Red",units:[[3,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})}),Blue:new B.BattleBrothers({player:"Blue",units:[new b.UNITS.BattleBrothers_Unit({position:[3,4]}),new b.UNITS.SupportBrothers_Unit({position:[5,2]})]})}});return c},exampleDS4:function(){var a=new A([{type:p2.Shape.CIRCLE,radius:3,x:12,y:24},{type:p2.Shape.CIRCLE,radius:3,x:12,y:10},{type:p2.Shape.CIRCLE,radius:3,x:12,y:15},{type:p2.Shape.CIRCLE,radius:3,x:12,y:6},{type:p2.Shape.CIRCLE,radius:3,x:12,y:1},{type:p2.Shape.CIRCLE,radius:3,x:12,y:3},{type:p2.Shape.CIRCLE,radius:3,x:12,y:5}]),b=B.BattleBrothers,c=new z({terrain:a,armies:{Red:new B.BattleBrothers({player:"Red",units:[[3,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})}),Blue:new B.BattleBrothers({player:"Blue",units:[[5,35]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})})}});return c},randomGame:function(){var a=d.players.RandomPlayer,b=[new a,new a];window.match=new d.Match(this.example1(),b),match.events.on("begin",function(a,b){window.RENDERER.render(a)}),match.events.on("move",function(a,b,d){console.log(c.ser(b))}),match.events.on("next",function(a,b,c){b instanceof z&&window.RENDERER.render(b)}),match.run().then(function(a){console.log(a.result())})},randomAbstractedGame:function(){var a=[new d.players.MonteCarloPlayer({simulationCount:2,timeCap:500}),new d.players.RandomPlayer],b=new D(this.example1());window.match=new d.Match(b,a),match.events.on("begin",function(a,b){var c=a.concreteGame.terrain;c.loadUnitsBut(a.concreteGame,c.terrain),window.RENDERER.renderGrid(c.terrain)}),match.events.on("move",function(a,b,d){console.log(c.ser(b))}),match.events.on("next",function(a,b,c){var d=b.concreteGame.terrain;d.loadUnitsBut(b.concreteGame,d.terrain),window.RENDERER.renderGrid(d.terrain)}),match.run().then(function(a){console.log(a.result())})},randomAbstractedGameDiscrete:function(){var a=[new d.players.MonteCarloPlayer({simulationCount:5,timeCap:2e3}),new d.players.RandomPlayer],b=new D(this.example1());window.match=new d.Match(b,a),match.events.on("move",function(a,b,d){console.log(c.ser(b))}),match.run().then(function(a){console.log(a.result()),alert(a.result())})},testGame:function(a,b){var e=d.players.RandomPlayer,f=[a||new e,b||new e];window.match=new d.Match(this.example1(),f),match.events.on("begin",function(a,b){window.RENDERER.render(a)}),match.events.on("move",function(a,b,d){console.log(c.ser(b)),window.RENDERER.renderSight(a)}),match.events.on("next",function(a,b,c){b instanceof z&&window.RENDERER.render(b)}),match.run().then(function(a){console.log(a.result())})}};var B=l.GrimFuture=function(){var a={},b={LightClaws:{range:0,attacks:1},CClaws:{range:0,attacks:2},Pistol:{range:12,attacks:1},AssaultRifle:{range:24,attacks:1},HeavyFlamethrower:{range:12,attacks:6,ap:1}},c={BattleBrother:f(o,{cost:22,equipments:[b.AssaultRifle,b.LightClaws],constructor:function(a){o.call(this,a)}}),AssaultBrother:f(o,{cost:22,equipments:[b.Pistol,b.CClaws]}),SupportBrother:f(o,{cost:50,equipments:[b.HeavyFlamethrower,b.LightClaws],constructor:function(a){o.call(this,a)}})},d={BattleBrothers_Unit:f(n,{quality:3,defense:6,fearless:!0,constructor:function(a){a=a||{},a.models||(a.models=h.range(5).map(function(){return new c.BattleBrother}).toArray()),n.call(this,a)}}),AssaultBrothers_Unit:f(n,{quality:3,defense:6,models:h.repeat(c.AssaultBrother,5).toArray(),fearless:!0}),SupportBrothers_Unit:f(n,{quality:3,defense:6,fearless:!0,constructor:function(a){a=a||{},a.models||(a.models=h.range(5).map(function(){return new c.SupportBrother}).toArray()),n.call(this,a)}})};a.BattleBrothers=f(m,{faction:"BattleBrothers","static MODELS":c,"static UNITS":d,constructor:function(a){m.call(this,a)}});return a}();l.DynamicScriptingPlayer=f(d.Player,{constructor:function(a){d.Player.call(this,a),i(this,a).array("rules",{defaultValue:[]}),this.__pendingActions__=[],this.__roundActions__=[],this.rules=this.ownRules()},ownRules:function(){var a=this;return Object.keys(Object.getPrototypeOf(this)).map(function(b){return a[b]}).filter(function(a){return"function"==typeof a&&a.name&&"rule"===a.name.substr(0,4)})},sortRules:function(){this.rules.sort(function(a,b){return b[0].priority-a[0].priority||b[1]-a[1]})},decision:function(a,b){var c,d,e=this.__pendingActions__,f=this.__roundActions__;if(this.adjustWeights(a,b),e.length<1)for(var g=0,h=this.rules.length;g<h;g++)if(c=this.rules[g],d=c.call(this,a,b)){d.forEach(function(a){a.__rule__=c}),e.push.apply(e,d),f.push.apply(f,d);break}return j(e.length<1,"No rule applied to game!"),e.shift()},adjustWeights:function(a,b){if(this.__lastRound__){if(this.__lastRound__.round<a.round){var c=this.gameWorth(a)-this.gameWorth(this.__lastRound__);this.__roundActions__.forEach(function(a){a.__rule__[1]+=a.worth()+c}),this.__lastRound__=a,this.__roundActions__=[],this.sortRules()}}else this.__lastRound__=a,this.__roundActions__=[]},gameWorth:function(a,b){var c=0,d=0,e=0,f=this.armiesAndUnits(a,b),g=f[1],h=f[3];h.forEach(function(a){d=a.cost(),a.isDead()&&(c+=d),e=a.size()-a.livingModels(),c+=d*e/a.size()}),g.forEach(function(a){d=a.cost(),a.isDead()&&(c-=d),e=a.size()-a.livingModels(),c-=d*e/a.size()})},"static __SERMAT__":{identifier:"DynamicScriptingPlayer",serializer:function(a){return this.serializeAsProperties(a,["name","rules"])}},shoot:function(a,b){return[new q(a.id),new t(a.id,b.id)]},assault:function(a,b){return[new q(a.id),new u(a.id,b.id)]},move:function(a,b){return[new q(a.id),b]},mostDangerousUnits:function E(a,b,c){var E=[],d=this.livingEnemyUnits(a,c);return d.forEach(function(c){this.canKill(a,c,b)&&E.push(c)}),E},dangerousUnits:function F(a,b,c){var F=[],d=this.livingEnemyUnits(a,c);return d.forEach(function(c){if(c.isEnabled){var d=c.models[0].equipments[0].range;(a.terrain.canShoot(c,b,d)||a.terrain.canSee(c,b)<=12)&&F.push(c)}}),F},canKill:function(a,b,c){return!(b.isDead()||!b.isEnabled||c.isDead()||!canKillShooting(a,b,c)&&!canKillAssaulting(a,b,c))},canKillShooting:function(a,b,c){return!(b.isDead()||c.isDead()||!b.isEnabled||!(bestAttackResultShooting(a,b,c)>=100))},canKillAssaulting:function(a,b,c){return!(b.isDead()||c.isDead()||!b.isEnabled||!(bestAttackResultAssaulting(a,b,c)>=100))},bestAttackResult:function G(a,b,c){if(!b.isDead()&&b.isEnabled&&!c.isDead()){var d=this.bestAttackResultShooting(a,b,c),e=this.bestAttackResultAssaulting(a,b,c),G=Math.max(d,e);return G}return 0},bestAttackResultShooting:function(a,b,c){if(!b.isDead()&&b.isEnabled&&!c.isDead()){var d=a.terrain.canSee(b,c),e=0,f=b.livingModels();f.forEach(function(a){a.equipments.forEach(function(a){a.range>=d&&(e+=a.attacks)})});var g=c.livingModels().length,h=100*e/g;return h>100&&(h=100),h}return 0},bestAttackResultAssaulting:function(a,b,c){if(!b.isDead()&&b.isEnabled&&!c.isDead()&&a.terrain.canShoot(b,c,12)){var d=0,e=b.livingModels();e.forEach(function(a){a.equipments.forEach(function(a){0===a.range&&(d+=a.attacks)})});var f=c.livingModels().length,g=100*d/f;return g>100&&(g=100),g}return 0},possibleUnits:function H(a,b){var c=this.armiesAndUnits(a,b)[1],H=[];for(var d in c)!c[d].isDead()&&c[d].isEnabled&&H.push(c[d]);return H},shootableUnits:function I(a,b,c){var d=this.livingEnemyUnits(a,b),I=[];for(var e in d){var f=d[e],g=c.models[0].equipments[0].range;a.terrain.canShoot(c,f,g)&&I.push(f)}return I},livingEnemyUnits:function(a,b){var c=this.armiesAndUnits(a,b)[2];return c.livingUnits()},armiesAndUnits:function(a,b){var c=a.armies[b],d=a.armies[b].units,e=a.opponent(b),f=a.armies[e],g=a.armies[e].units;return[c,d,f,g]},wounded:function(a,b){return a.livingModels().length<a.size()},canWoundALot:function(a,b,c){return!(b.isDead()||!b.isEnabled||c.isDead())&&bestAttackResult(a,b,c)>=75},canWound:function(a,b,c){return!(b.isDead()||!b.isEnabled||c.isDead())&&bestAttackResult(a,b,c)>0},maxCost:function J(a){var J=0;return a.forEach(function(a){var b=a.cost();b>J&&(J=b)}),J},mostExpensiveUnit:function K(a){var b=0,K=null;return a.forEach(function(a){var c=a.cost();c>b&&(b=c,K=a)}),K},rule_3A:e(3,function(a,b){var c=this.possibleUnits(a,b);this.armiesAndUnits(a,b)[2];if(0===a.round)for(var d=0;d<c.length;d++){var e=c[d],f=this.shootableUnits(a,b,e);if(f.length>1)for(var g=0;g<f.length;g++){var h=f[g];if(h.cost()===this.mostExpensiveUnit(f).cost())return this.shoot(e,h)}}return null}),rule_2A:e(2,function(a,b){var c=this.livingEnemyUnits(a,b),d=this.possibleUnits(a,b);if(0===a.round)for(var e=0;e<d.length;e++)for(var f=d[e],g=0;g<c.length;g++){var h=c[g];if(this.wounded(h,a)&&a.terrain.canShoot(f,h,12))return this.assault(f,h)}return null}),rule_1A:e(1,function(a,b){for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];return this.shoot(e,h)}return null}),rule_1B:e(1,function(a,b){for(var c=this.livingEnemyUnits(a,b),d=this.possibleUnits(a,b),e=0;e<d.length;e++)for(var f=d[e],g=0;g<c.length;g++){var h=c[g],i=f.models[0].equipments[0].range;if(a.terrain.canShoot(f,h,i)===!1){var j=f.getMoveActions(a);if(j.length>0)return this.move(f,j[0])}}return null})});l.Renderer=f({constructor:function(a){a=this.canvas=a||document.getElementById("wargame-canvas");var b=this.ctx=a.getContext("2d");b.fillStyle="white"},renderScope:function(a,b,c){var d=this.canvas,e=this.ctx;e.save(),e.scale(d.width/a,d.height/b);try{c.call(this,e)}finally{e.restore()}},render:function(a){var b=a.terrain;this.renderScope(b.width,b.height,function(c){c.clearRect(0,0,this.canvas.width,this.canvas.height);for(var d=0,e=b.width;d<e;d++)for(var f=0,g=b.height;f<g;f++)b.isPassable([d,f])?this.drawSquare(d,f,1,1,"#CCCCCC"):this.drawSquare(d,f,1,1,"black");var h=this,i=a.armies;c.strokeStyle="black",c.font="1px Arial";for(var j in i)i[j].units.forEach(function(a){a.isDead()||(h.drawSquare(a.position[0],a.position[1],1,1,a.army.player),c.fillStyle="black",c.fillText(a.id,a.position[0],a.position[1]))})})},renderSight:function(a,b){if(b=b||a.__activeUnit__){var c=a.terrain;this.renderScope(c.width,c.height,function(a){var d,e,f=b.maxRange(),g=c.areaOfSight(b,f);for(var h in g)d=.8*(1-g[h]/f)+.2,e=h.split(","),this.drawSquare(+e[0],+e[1],1,1,"rgba(255,255,0,"+d+")")})}},drawSquare:function(a,b,c,d,e){var f=this.ctx;f.fillStyle=e,f.fillRect(a,b,1,1)}});var C=l.StrategicAttackAction=f(p,{constructor:function(a,b){this.unitId=a,this.targetId=b},executeMovement:function(a,b,c){var d=a.activePlayer(),e=this.unitById(a,this.unitId),f=this.unitById(a,this.targetId),g=a,h=b.filter(function(b){return b instanceof s&&(b.__distance__=a.terrain.getDistance(e.position,f.position),!0)}),i=[];return i=h.filter(function(b){return b.__range__=a.terrain.canShoot(e,f,e.maxRange(),g),b.__range__!==1/0}),i.length>0?(i.sort(function(a,b){return a.__range__-b.__range__}),a.next(k(d,i[0]),null,c)):(h.sort(function(a,b){return a.__distance__-b.__distance__}),a.next(k(d,h[0]),null,c))},getShots:function(a,b){var c=this;return b=b||a.moves()[a.activePlayer()],b.filter(function(a){return a instanceof t&&a.targetId===c.targetId})},execute:function(a,b){var c=this,d=a.concreteGame,e=d.activePlayer();d=d.next(k(e,new q(c.unitId)),null,b);var f=d.moves()[e],g=this.getShots(d,f);return g.length<1&&(d=this.executeMovement(d,f,b),d.__activeUnit__&&d.__activeUnit__.id===c.unitId&&(g=this.getShots(d))),g.length>0?a.concreteGame=d.next(k(e,g[0]),null,b).randomNext():d.__activeUnit__&&d.__activeUnit__.id===c.unitId?a.concreteGame=d.next(k(e,new r(c.unitId)),null,b):a.concreteGame=d,a},"static __SERMAT__":{identifier:"StrategicAttackAction",serializer:function(a){return[a.unitId,a.targetId]}}}),D=l.AbstractedWargame=f(d.Game,{constructor:function(a){this.players=a.players,d.Game.call(this,a.activePlayer()),this.concreteGame=a},result:function(){return this.concreteGame.result()},moves:function(){if(this.result())return null;var a=this.concreteGame,b=this.activePlayer(),c={};return c[b]=h.product(a.armies[b].units.filter(function(b){return!b.isDead(a)&&b.isEnabled}),a.armies[a.opponent()].units.filter(function(a){return!a.isDead()})).mapApply(function(a,b){return new C(a.id,b.id)}).toArray(),c},next:function(a,b,d){var e=d?this:c.sermat(this),f=this.activePlayer(),g=a[f];return g.execute(e,d),e.activePlayers=e.concreteGame.activePlayers,e},"static __SERMAT__":{identifier:"AbstractedWargame",serializer:function(a){return[a.concreteGame]}}});return[].forEach(function(a){a.__SERMAT__.identifier=l.__package__+"."+a.__SERMAT__.identifier,l.__SERMAT__.include.push(a)}),c.include(l),l});
//# sourceMappingURL=ludorum-wargame.min.js.map