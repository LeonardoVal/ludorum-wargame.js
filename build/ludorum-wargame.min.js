//! ludorum-wargame 0.0.1

(function(a){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","ludorum"],a):"object"==typeof exports&&module.exports?module.exports=a(require("creatartis-base"),require("sermat"),require("ludorum")):this["ludorum-wargame"]=a(this.base,this.Sermat,this.ludorum)}).call(this,function a(b,c,d){"use strict";function e(a,b){return b.priority=a,b}function f(a){var b={};return a&&"[object Function]"===b.toString.call(a)}var k=b.declare,l=b.iterable,m=b.Iterable,n=b.initialize,o=b.raiseIf,p=b.obj,q={__package__:"ludorum-wargame",__name__:"ludorum_wargame",__init__:a,__dependencies__:[b,c,d],__SERMAT__:{include:[b]}},r=q.Army=k({constructor:function(a){var b=this;n(this,a).string("player",{ignore:!0}).number("score",{coerce:!0,defaultValue:0}).array("units"),this.units&&this.units.forEach(function(a,c){a.id=b.player+"#"+c,a.army=b})},isEnabled:function(){for(var a=0,b=this.units.length;a<b;a++)if(this.units[a].isEnabled)return!0;return!1},startRound:function(){return this.units.filter(function(a){return a.startRound()}).length},actions:function(a){var b=a.activeUnit();return b?b.getActions(a):this.units.filter(function(a){return a.isEnabled}).map(function(a){return new v(a.id)})},isEliminated:function(a){return this.units.filter(function(a){return!a.isDead()}).length<=0},livingUnits:function(){return this.units.filter(function(a){return!a.isDead()})},worth:function(){return l(this.units).map(function(a){return a.worth()}).sum()},"static __SERMAT__":{serializer:function(a){return[{player:a.player,units:a.units,score:a.score}]}}}),s=q.Unit=k({radius:.5,quality:3,defense:4,constructor:function(a){n(this,a).array("position").array("models").bool("isActive",{ignore:!0}).bool("hasMoved",{ignore:!0}).bool("isEnabled",{ignore:!0})},cost:function(){return l(this.models).map(function(a){return a.cost||0}).sum()},size:function(){return this.models.length},livingModels:function(){return this.models.filter(function(a){return a.health()>0})},health:function(){return this.livingModels().length},isDead:function(){return this.health()<=0},worth:function(){return l(this.models).map(function(a){return a.health()/a.toughness*a.cost}).sum()},getActions:function(a){var b=[new w(this.id)];return this.isActive&&(this.hasMoved||(b=b.concat(this.getMoveActions(a))),b=b.concat(this.getShootActions(a))),b},maxRange:function(){var a=-(1/0);return this.livingModels().forEach(function(b){b.equipments.forEach(function(b){+b.range>a&&(a=+b.range)})}),a},getShootActions:function(a){var b=a.armies[a.opponent()].units,c=this,d=b.filter(function(b){return a.terrain.canShoot(c,b)!=1/0}).map(function(a){return new y(c.id,a.id)});return d},getAssaultActions:function(a){var b=a.armies[a.opponent()].units,c=this,d=b.filter(function(b){return a.terrain.canShoot(c,b)!=1/0}).map(function(a){return new z(c.id,a.id)});return d},getMoveActions:function(a){var b=this;return l(a.terrain.reachablePositions(b)).mapApply(function(a,c){var d=a.split(",");return new x(b.id,[+d[0],+d[1]],c>6)}).toArray()},startRound:function(){return this.isActive=!1,this.hasMoved=!1,this.isEnabled=this.health()>0,this.isEnabled},activate:function(a){o(!this.isEnabled,"Unit ",this.id," is not enabled!"),o(this.isActive,"Unit ",this.id," is already active!"),o(this.health()<=0,"Unit ",this.id," has been eliminated!"),this.isActive=!0,a.__activeUnit__=this},endTurn:function(a){this.isActive=!1,this.isEnabled=!1,a.__activeUnit__===this&&(a.__activeUnit__=null)},move:function(a,b,c){o(!this.isActive,"Unit ",this.id," is not active!"),this.position=b,this.hasMoved=!0,c&&this.endTurn(a)},suffer:function(a,b){var c,d,e,f=this.models;for(e=0;b>0&&e<f.length&&(c=f[e],d=c.health(),!(d>0&&(c.wounds+=Math.min(b,d),b-=d,b<=0)));e++);return this.isEnabled=this.isEnabled&&!this.isDead(),this.isEnabled},influence:function(a){},"static __SERMAT__":{serializer:function(a){var b={position:[a.position[0],a.position[1]],models:a.models};return["isActive","hasMoved","isEnabled"].forEach(function(c){a.hasOwnProperty(c)&&(b[c]=a[c])}),[b]}}}),t=q.Model=k({toughness:1,equipments:[],constructor:function(a){this.wounds=0|a},health:function(){return this.toughness-this.wounds},shooting:function(a){return a=a||1,equipments.filter(function(b){return b.range>=a})},melee:function(){return equipments.filter(function(a){return a.range<1})},"static __SERMAT__":{serializer:function(a){return[a.wounds]}}}),u=q.GameAction=k({aleatories:function(a){return null},execute:b.objects.unimplemented("GameAction","execute(game, haps)"),unitById:function(a,b){b=b||this.unitId;for(var c=null,d=0;!c&&d<a.players.length;d++)for(var e=a.armies[a.players[d]].units,f=0;f<e.length;f++)if(e[f].id==b){c=e[f];break}return o(!c,"Unit ",b," was not found!"),c},worth:function(){return 0}}),v=q.ActivateAction=k(u,{constructor:function(a){this.unitId=a},execute:function(a){this.unitById(a).activate(a)},"static __SERMAT__":{identifier:"ActivateAction",serializer:function(a){return[a.unitId]}}}),w=q.EndTurnAction=k(u,{constructor:function(a){this.unitId=a},execute:function(a){this.unitById(a).endTurn(a)},"static __SERMAT__":{identifier:"EndTurnAction",serializer:function(a){return[a.unitId]}}}),x=q.MoveAction=k(u,{constructor:function(a,b,c){this.unitId=a,this.position=b,this.run=c},execute:function(a){this.unitById(a).move(a,this.position,this.run)},"static __SERMAT__":{identifier:"MoveAction",serializer:function(a){return[a.unitId,Array.apply(Array,a.position),a.run]}}}),y=q.ShootAction=k(u,{constructor:function(a,b){this.unitId=a,this.targetId=b},aleatories:function(a){var b=this.unitById(a),c=this.unitById(a,this.targetId),d=a.terrain.canShoot(b,c),e=0;b.models.forEach(function(a){a.equipments.forEach(function(a){a.range>=d&&(e+=a.attacks)})});var f=new D(b.quality,c.defense,e);return{wounds:f}},execute:function(a,b){var c=b.wounds,d=this.unitById(a,this.targetId);if(c>0){var e=d.worth();d.suffer(a,c),this.worth=e-d.worth()}this.unitById(a,this.unitId).endTurn(a)},"static __SERMAT__":{identifier:"ShootAction",serializer:function(a){return[a.unitId,a.targetId]}}}),z=q.AssaultAction=k(u,{constructor:function(a,b){this.unitId=a,this.targetId=b},aleatories:function(a){return null},execute:function(a,b){var c=0,d=b.wounds,e=this.unitById(a,this.targetId);d>0&&e.suffer(a,d);var f=this.unitById(a,this.unitId);f.disable(a),this.worth=0;var g=e.cost();e.isDead(a)&&(this.worth+=g),this.worth+=g*d/e.size(),f.isDead(a)&&(this.worth-=f.cost()),this.worth-=f.cost()*c/f.size()},"static __SERMAT__":{identifier:"AssaultAction",serializer:function(a){return[a.unitId,a.targetId]}}}),A=b.math.combinations,B=q.rolls=function(a,b){return b<=0?[1]:m.range(b+1).map(function(c){return Math.pow(a,c)*Math.pow(1-a,b-c)*A(b,c)}).toArray()},C=q.rerolls=function(a,b){var c=m.repeat(0,b.length).toArray();return b.forEach(function(b,d){0===d?c[0]+=b:B(a,d).forEach(function(a,d){c[d]+=b*a})}),c},D=(q.addRolls=function(a,b){var c=a.length,d=b.length;return m.range(c+d-1).map(function(e){return m.range(e+1).filter(function(a){return a<c&&e-a<d},function(c){return a[c]*b[e-c]}).sum()}).toArray()},q.ShootAleatory=k(d.aleatories.Aleatory,{constructor:function(a,b,c){this.shooterQuality=0|a,this.targetDefense=0|b,this.attackCount=0|c,this.__hitProb__=Math.max(0,Math.min(1,(6-a+1)/6)),this.__saveProb__=Math.max(0,Math.min(1,(6-b+1)/6));var d=C(this.__saveProb__,B(this.__hitProb__,c));this.__distribution__=l(d).map(function(a,b){return[b,a]}).toArray()},distribution:function(){return l(this.__distribution__)},value:function(a){return(a||b.Randomness.DEFAULT).weightedChoice(this.__distribution__)},"static __SERMAT__":{identifier:"ShootAleatory",serializer:function(a){return[a.shooterQuality,a.targetDefense,a.attackCount]}}})),E=q.Wargame=k(d.Game,{name:"Wargame",players:["Red","Blue"],rounds:5,constructor:function(a){d.Game.call(this,a.activePlayer||this.players[0]),n(this,a).object("armies").object("terrain").integer("round",{coerce:!0,defaultValue:-1}).number("rounds",{coerce:!0,ignore:!0}).object("__activeUnit__",{ignore:!0}),this.round<0?this.nextRound():this.nextTurn()},nextTurn:function(){var a=this.activePlayer();if(!this.armies[a].isEnabled()){var b=(this.players.indexOf(a)+1)%this.players.length;this.activePlayers=[this.players[b]],b||this.nextRound()}return this},nextRound:function(){this.round++;var a=this.armies;for(var b in a)a[b].startRound();return this},scores:function(){return l(this.armies).mapApply(function(a,b){return[a,b.worth()]}).toObject()},result:function(){var a=this.players[0],b=this.players[1];if(this.armies[a].isEliminated(this)||this.armies[b].isEliminated(this)||this.round>=this.rounds){var c=this.scores();return this.zerosumResult(c[a]-c[b],a)}return null},synchronizeMetagame:function(){this.terrain.resetTerrain(this)},activeUnit:function(){return this.__activeUnit__},moves:function(){if(!this.result()){this.synchronizeMetagame();var a=this.activePlayer();return p(a,this.armies[a].actions(this))}return null},next:function(a,b,e){var f=this.activePlayer(),g=a[f];o(!g,"Active player ",f," has no actions!");var h=g.aleatories(this);if(o(!h&&b,"Unexpected haps! ",b),h&&!b)return new d.Contingent(this,a,h,e);var i=e?this:c.clone(this);return g.execute(i,b),i.nextTurn()},"static __SERMAT__":{serializer:function(a){var b={activePlayer:a.activePlayer(),armies:a.armies,terrain:a.terrain,round:a.round,rounds:a.rounds};return a.__activeUnit__&&(b.__activeUnit__=a.__activeUnit__),[b]}}}),F=q.Terrain=k({SURROUNDINGS:[{dx:-1,dy:-1,cost:Math.SQRT2},{dx:-1,dy:0,cost:1},{dx:-1,dy:1,cost:Math.SQRT2},{dx:0,dy:-1,cost:1},{dx:0,dy:1,cost:1},{dx:1,dy:-1,cost:Math.SQRT2},{dx:1,dy:0,cost:1},{dx:1,dy:1,cost:Math.SQRT2}],tileSet:[{passable:!0,visible:!0},{passable:!1,visible:!1}],map:["000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000010000000000000000000000000100000000000","111111111110000001111111111110000000111111111111","000000000010000000000000000000000000100000000000","000000000000000000000000000000000000000000000000","000000000010000000000000000000000000100000000000","000000000010000000000000000000000000100000000000","000000000010000000000001000000000000100000000000","000000000010000000000001000000000000100000000000","000000000010000000000001000000000000100000000000","000000000010000000000001000000000000100000000000","000000000010000000000001000000000000100000000000","000000000010000000000001000000000000100000000000","000000000010000000000001000000000000100000000000","000000000010000000000001000000000000100000000000","000000000010000000000001000000000000100000000000","000000000010000000000001000000000000100000000000","000000000000000000000001000000000000000000000000","000000000000000000000001000000000000000000000000","000000000010000000000001000000000000100000000000","000000000010000000000001000000000000100000000000","000000000000000000000001000000000000000000000000","000000000010000000000001000000000000100000000000","111111111110000000000001000000000000111111111111","000000000010000000000001000000000000100000000000","000000000000000000000001000000000000000000000000","000000000010000000000001000000000000100000000000","000000000010000000000000000000000000100000000000","000000000010000000000000000000000000100000000000","000000000010000000000000000000000000100000000000","000000000010000000000000000000000000100000000000","000000000010000001111111111110000000100000000000","000000000010000000000000000000000000100000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000","000000000000000000000000000000000000000000000000"].map(function(a){return new Uint8Array(a.split(""))}),__unitsByPosition__:{},constructor:function(a){this.width=this.map.length,this.height=this.map[0].length},resetTerrain:function(a){this.__unitsByPosition__=this.unitsByPosition(a)},unitsByPosition:function(a){var b=a.armies,c={};for(var d in b)b[d].units.forEach(function(a){a.isDead()||(c[a.position]=a)});return c},tileAt:function(a){var b=this.map[a[0]]&&this.map[a[0]][a[1]];return this.tileSet[b]},isPassable:function(a,b){var c=this.tileAt(a);return!(!c||!c.passable||b&&this.__unitsByPosition__.hasOwnProperty(a))},isVisible:function(a,b){var c=this.tileAt(a);return!(!c||!c.visible||b&&this.__unitsByPosition__.hasOwnProperty(a))},distance:function(a,b){var c=Math.abs(a[0]-b[0]),d=Math.abs(a[1]-b[1]);return Math.sqrt(c*c+d*d)},reachablePositions:function(a,b){b=b||12;var c,d,e,f,g,h={},i=[a.position],j=(this.width,this.height,this.SURROUNDINGS);h[a.position]=0;for(var k=0;k<i.length;k++){c=i[k],e=h[c];for(var l=0;l<j.length;l++)g=j[l],f=e+g.cost,f>b||(d=[c[0]+g.dx,c[1]+g.dy],!h.hasOwnProperty(d)&&this.isPassable(d,!0)&&(h[d]=f,i.push(d)))}return h},canReachAStarInf:function(a){var b=new ludorum_wargame.Graph(this,{diagonal:!0,end:a.target.position,start:a.attacker.position}),c=b.grid[a.target.position[0]][a.target.position[1]],d=b.grid[a.attacker.position[0]][a.attacker.position[1]],e=b.astar.search(b,d,c,{exitCondition:a.exitCondition,heuristic:this.heuristicInfluence,influenceMap:a.influenceMap,role:a.role});return e},canReachAStar:function(a){var b=new ludorum_wargame.Graph(this,{diagonal:!0}),c=b.grid[a.target.position[0]][a.target.position[1]],d=b.grid[a.attacker.position[0]][a.attacker.position[1]],e=b.astar.search(b,d,c,{exitCondition:a.exitCondition});return e},getInf:function(a,b,c){var d=a[0],e=a[1];return"Red"==b?c[d][e]:-c[d][e]},heuristicInfluence:function(a,b,c,d){var e=Math.abs(b.x-a.x),f=Math.abs(b.y-a.y),g="Red"==d?c[a.x][a.y]:-c[a.x][a.y];return e+f+60*g},distanceToTurns:function(a){var b=0;return a<=6?b:b=a%12===0?a/12:a/12+1},undefinedAsignArray:function(a,b){a[b]=void 0!==a[b]?a[b]:[]},sparseMatrix:function(a,b,c,d){void 0!=d.value&&(a[c[0]]=void 0!==a[c[0]]?a[c[0]]:[],a[c[0]][[c[1]]]=void 0!==a[c[0]][[c[1]]]?a[c[0]][[c[1]]]:{},a[c[0]][[c[1]]][d.key]=d.value)},"dual bresenham":function(a,b,c){c=c||1/0;for(var d,e=[],f=Math.abs(b[0]-a[0]),g=Math.abs(b[1]-a[1]),h=a[0]<b[0]?1:-1,i=a[1]<b[1]?1:-1,j=a.slice(),k=f-g;c--&&(e.push(j.slice()),j[0]!==b[0]||j[1]!==b[1]);)d=2*k,d>-g&&(k-=g,j[0]+=h),d<f&&(k+=f,j[1]+=i);return e},canShoot:function(a,b){if(a.army===b.army)return 1/0;var c=this.distance(a.position,b.position);if(c>a.maxRange())return 1/0;for(var d,e=this.bresenham(a.position,b.position,c),f=0;f<e.length;f++)if(d=e[f],!this.isVisible(d)||this.__unitsByPosition__[d]&&this.__unitsByPosition__[d].id!==a.id&&this.__unitsByPosition__[d].id!==b.id)return 1/0;return c},areaOfSight:function(a,b){b=b||1/0;var c=a.position,d=this,e={};return l(this.BRESENHAM_CACHE).forEachApply(function(a,f){for(var g,h=1;h<f.length&&h<=b&&(g=f[h],g=[c[0]+g[0],c[1]+g[1]],d.isVisible(g))&&(e[g]=h,!d.__unitsByPosition__[g]);h++);}),e},"static __SERMAT__":{serializer:function(a){return[]}}});F.BRESENHAM_CACHE=F.prototype.BRESENHAM_CACHE=function(a){for(var b={radius:a},c=-a;c<=a;c++)b[[c,-a]]=F.bresenham([0,0],[c,-a]),b[[c,+a]]=F.bresenham([0,0],[c,+a]),c!==-a&&c!==a&&(b[[-a,c]]=F.bresenham([0,0],[-a,c]),b[[+a,c]]=F.bresenham([0,0],[+a,c]));return b}(50);q.InfluenceMap=k({momentum:.7,decay:.5,iterations:25,constructor:function(a,b){this.width=a.terrain.width,this.height=a.terrain.height,this.grid=this.matrix(this.width),this.terrain=a.terrain},getInf:function(a){var b=a[0],c=a[1];return"Red"==this.role?this.grid[b][c]:-this.grid[b][c]},matrix:function(a){return Array(a).fill(0).map(function(b){return Array(a).fill(0).map(function(a){return 0})})},update:function(a,b){var c=a.concreteInfluence||this.grid,d=b||this.iterations;this.role=a.activePlayer(),this.unitsInfluences(a);for(var e=0;e<d;e++)c=this.spread(c);return c},unitsInfluences:function(a){var b,c,d,e=this,f=this.grid;for(var g in a.armies)b="Red"===g?1:-1,a.armies[g].units.forEach(function(a){a.isDead()||(c=0|a.position[0],d=0|a.position[1],f[c]?f[c][d]||(f[c][d]=0):(f[c]=[],f[c][d]=0),f[c][d]=e.influence(a,b))})},influence:function(a,b){return a.worth()*b*1e3},getMomentumInf:function(a,b,c,d){var e,f,g,h,i,j=0;for(f=-1;f<2;f++)for(g=-1;g<2;g++)(0!==f||0!==g)&&a[b+f]&&(e=a[b+f][c+g])&&(e*=d[f*f+g*g],h=j<0?-j:j,i=e<0?-e:e,h<i&&(j=e));return j},spread:function(a){for(var b,c,d=this.decay,e=[NaN,Math.exp(-1*d),Math.exp(-Math.SQRT2*d)],f=this.momentum,g=[],h=this.terrain,i=0;i<a.length;i++)for(var j=0;j<a[i].length;j++)b=a[i][j],1===h.map[i][j]?(g[i]=g[i]?g[i]:[],g[i][j]="t"):(c=this.getMomentumInf(a,i,j,e),g[i]=g[i]?g[i]:[],g[i][j]=b*(1-f)+c*f);return g}});q.test={example0:function(){var a=new F,b=G.BattleBrothers,c=new E({terrain:a,armies:{Red:new G.BattleBrothers({player:"Red",units:[[3,10]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})}),Blue:new G.BattleBrothers({player:"Blue",units:[[40,10],[40,20],[40,15],[40,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})})}});return c},example1:function(){var a=new F,b=G.BattleBrothers,c=new E({terrain:a,armies:{Red:new G.BattleBrothers({player:"Red",units:[[3,10],[3,20],[3,15],[3,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})}),Blue:new G.BattleBrothers({player:"Blue",units:[[40,10],[40,20],[40,15],[40,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})})}});return c},exampleDS1:function(){var a=new F([{type:p2.Shape.CIRCLE,radius:2,x:12,y:24},{type:p2.Shape.CIRCLE,radius:2,x:12,y:10},{type:p2.Shape.CIRCLE,radius:2,x:12,y:15},{type:p2.Shape.CIRCLE,radius:2,x:12,y:6},{type:p2.Shape.CIRCLE,radius:2,x:12,y:1},{type:p2.Shape.CIRCLE,radius:2,x:12,y:3},{type:p2.Shape.CIRCLE,radius:2,x:12,y:5}]),b=G.BattleBrothers,c=new E({terrain:a,armies:{Red:new G.BattleBrothers({player:"Red",units:[[3,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})}),Blue:new G.BattleBrothers({player:"Blue",units:[[3,4]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})})}});return c},exampleDS2:function(){var a=new F([{type:p2.Shape.CIRCLE,radius:2,x:12,y:24},{type:p2.Shape.CIRCLE,radius:2,x:12,y:10},{type:p2.Shape.CIRCLE,radius:2,x:12,y:15},{type:p2.Shape.CIRCLE,radius:2,x:12,y:6},{type:p2.Shape.CIRCLE,radius:2,x:12,y:1},{type:p2.Shape.CIRCLE,radius:2,x:12,y:3},{type:p2.Shape.CIRCLE,radius:2,x:12,y:5}]),b=G.BattleBrothers,c=new E({terrain:a,armies:{Red:new G.BattleBrothers({player:"Red",units:[[3,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})}),Blue:new G.BattleBrothers({player:"Blue",units:[new b.UNITS.BattleBrothers_Unit({position:[3,4],models:[new b.MODELS.BattleBrother(1),new b.MODELS.BattleBrother,new b.MODELS.BattleBrother,new b.MODELS.BattleBrother,new b.MODELS.BattleBrother]})]})}});return c},exampleDS3:function(){var a=new F([{type:p2.Shape.CIRCLE,radius:2,x:12,y:24},{type:p2.Shape.CIRCLE,radius:2,x:12,y:10},{type:p2.Shape.CIRCLE,radius:2,x:12,y:15},{type:p2.Shape.CIRCLE,radius:2,x:12,y:6},{type:p2.Shape.CIRCLE,radius:2,x:12,y:1},{type:p2.Shape.CIRCLE,radius:2,x:12,y:3},{type:p2.Shape.CIRCLE,radius:2,x:12,y:5}]),b=G.BattleBrothers,c=new E({terrain:a,armies:{Red:new G.BattleBrothers({player:"Red",units:[[3,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})}),Blue:new G.BattleBrothers({player:"Blue",units:[new b.UNITS.BattleBrothers_Unit({position:[3,4]}),new b.UNITS.SupportBrothers_Unit({position:[5,2]})]})}});return c},exampleDS4:function(){var a=new F([{type:p2.Shape.CIRCLE,radius:3,x:12,y:24},{type:p2.Shape.CIRCLE,radius:3,x:12,y:10},{type:p2.Shape.CIRCLE,radius:3,x:12,y:15},{type:p2.Shape.CIRCLE,radius:3,x:12,y:6},{type:p2.Shape.CIRCLE,radius:3,x:12,y:1},{type:p2.Shape.CIRCLE,radius:3,x:12,y:3},{type:p2.Shape.CIRCLE,radius:3,x:12,y:5}]),b=G.BattleBrothers,c=new E({terrain:a,armies:{Red:new G.BattleBrothers({player:"Red",units:[[3,2]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})}),Blue:new G.BattleBrothers({player:"Blue",units:[[5,35]].map(function(a){return new b.UNITS.BattleBrothers_Unit({position:a})})})}});return c},randomGame:function(){var a=d.players.RandomPlayer,b=[new a,new a];window.match=new d.Match(this.example1(),b),match.events.on("begin",function(a,b){window.RENDERER.render(a)}),match.events.on("move",function(a,b,d){console.log(c.ser(b))}),match.events.on("next",function(a,b,c){b instanceof E&&window.RENDERER.render(b)}),match.run().then(function(a){console.log(a.result())})},randomAbstractedGame:function(){var a=[new d.players.RandomPlayer,new d.players.RandomPlayer],b=new I(this.example1());window.match=new d.Match(b,a),match.events.on("begin",function(a,b){a.concreteGame.terrain;window.RENDERER.render(a.concreteGame)}),match.events.on("move",function(a,b,d){console.log(c.ser(b))}),match.events.on("next",function(a,b,c){try{b.concreteGame.terrain;window.RENDERER.render(b.concreteGame)}catch(d){console.log(d)}}),match.run().then(function(a){console.log("randomAbstractedGame"),console.log(a.result())})},randomAbstractedGameDiscrete:function(){var a=[new d.players.MonteCarloPlayer({simulationCount:500,timeCap:2e4}),new d.players.RandomPlayer],b=new I(this.example1());window.match=new d.Match(b,a),match.events.on("begin",function(a,b){a.concreteGame.terrain;window.RENDERER.render(a.concreteGame)}),match.events.on("move",function(a,b,d){console.log(c.ser(b))}),match.events.on("next",function(a,b,c){b.concreteGame.terrain;window.RENDERER.render(b.concreteGame)}),match.run().then(function(a){console.log("randomAbstractedGameDiscrete"),console.log(a.result())})},testGame:function(a,b){var e=d.players.RandomPlayer,f=[a||new e,b||new e];window.match=new d.Match(this.example1(),f),match.events.on("begin",function(a,b){window.RENDERER.render(a)}),match.events.on("move",function(a,b,d){console.log(c.ser(b)),window.RENDERER.renderSight(a)}),match.events.on("next",function(a,b,c){b instanceof E&&window.RENDERER.render(b)}),match.run().then(function(a){console.log(a.result())})}};var G=q.GrimFuture=function(){var a={},b={LightClaws:{range:0,attacks:1},CClaws:{range:0,attacks:2},Pistol:{range:12,attacks:1},AssaultRifle:{range:24,attacks:1},HeavyFlamethrower:{range:12,attacks:6,ap:1}},c={BattleBrother:k(t,{cost:22,equipments:[b.AssaultRifle,b.LightClaws],constructor:function(a){t.call(this,a)}}),AssaultBrother:k(t,{cost:22,equipments:[b.Pistol,b.CClaws]}),SupportBrother:k(t,{cost:50,equipments:[b.HeavyFlamethrower,b.LightClaws],constructor:function(a){t.call(this,a)}})},d={BattleBrothers_Unit:k(s,{quality:3,defense:6,fearless:!0,constructor:function(a){a=a||{},a.models||(a.models=m.range(5).map(function(){return new c.BattleBrother}).toArray()),s.call(this,a)}}),AssaultBrothers_Unit:k(s,{quality:3,defense:6,models:m.repeat(c.AssaultBrother,5).toArray(),fearless:!0}),SupportBrothers_Unit:k(s,{quality:3,defense:6,fearless:!0,constructor:function(a){a=a||{},a.models||(a.models=m.range(5).map(function(){return new c.SupportBrother}).toArray()),s.call(this,a)}})};a.BattleBrothers=k(r,{faction:"BattleBrothers","static MODELS":c,"static UNITS":d,constructor:function(a){r.call(this,a)}});return a}();q.DynamicScriptingPlayer=k(d.Player,{constructor:function(a){d.Player.call(this,a),n(this,a).array("rules",{defaultValue:[]}),this.__pendingActions__=[],this.rules=this.ownRules(),this.sortRules()},ownRules:function(){var a=this;return Object.keys(Object.getPrototypeOf(this)).map(function(b){return[a[b],1]}).filter(function(a){var b=a[0];return"function"==typeof b&&b.name&&"rule"===b.name.substr(0,4)})},sortRules:function(){this.rules.sort(function(a,b){return b[0].priority-a[0].priority||b[1]-a[1]})},sortRuleListByWeight:function(a){a.sort(function(a,b){return b[1]-a[1]})},firstRules:function(a,b,c){for(var d,e,f=[],g=0,h=this.rules.length;g<h;g++)this.rules[g][0].priority==c&&(d=this.rules[g],e=d[0].call(this,a,b),e&&f.push(d));return this.sortRuleListByWeight(f),f},decision:function(a,b){a.synchronizeMetagame();for(var c,d,e=this.armiesAndUnits(a,b),f=e[1],g=0,h=0;h<f.length;h++)(f[h].isEnabled||f[h].isActive)&&(g+=1);var i=0;g===f.length&&(i=this.gameWorth(a,b));var j=[];if(this.__pendingActions__.length<1)for(var k=12;k>0;){var l=this.firstRules(a,b,k);if(l.length>0){for(var m=0,n=0;n<l.length;n++){var p=l[n];m+=p[1]}if(m>l.length)for(var q=0,r=0,s=Math.random(),t=0;n<l.length;t++)q=l[t][1]/m,r+=q,s<=r&&(c=l[t],d=c[0].call(this,a,b));else c=l[Math.floor(Math.random()*l.length)],d=c[0].call(this,a,b);if(d){d.forEach(function(a){a.__rule__=c}),this.__pendingActions__=this.__pendingActions__.concat(d),j=j.concat(d);for(var u=0,v=0;v<f.length;v++)f[v].isEnabled&&!f[v].isActive||(u+=1);return this.__pendingActions__.shift()}}else k-=1}return o(this.__pendingActions__.length<1,"No rule applied to game!"),this.__pendingActions__.shift()},participate:function(a,b){return this.attachToMatch(a.state(),a),this},attachToMatch:function(a,b){var c=this,d=0,e=[],f=a;b.events.on("move",function(a,b,c){var d=a.activePlayer();d===a.players[0]&&e.push(b[d])}),b.events.on("next",function(a,b,g){!b.isContingent&&b.round>d&&!a.isContingent&&(c.adjustWeights(a,a.players[0],e,f),d=b.round,e=[],f=a)})},training:function(a,b){b=b||new d.players.RandomPlayer;var c=new d.Match(a,[this,b]),e=a;this.attachToMatch(e,c)},adjustWeights:function(a,b,c,d){var e=[];c.forEach(function(a){e.push(a.__rule__)});var g,h,i,j=this.gameWorth(d,b),k=(this.gameWorth(a,b)-j)/10;if(k<0)for(g=0;g<this.rules.length;g++)for(h=0;h<e.length;h++)this.rules[g][0].name!=e[h][0].name&&(this.rules[g][1]-=k);else{var l=[];for(h=0;h<e.length;h++)if(i=e[h][0].name,l.indexOf(i)<0)for(g=0;g<this.rules.length;g++)this.rules[g][0].name==i&&(this.rules[g][1]+=k,l.push(i))}for(var m=0;m<c.length;m++){var n=c[m];i=n.__rule__[0].name,n.__rule__[1]||(n.__rule__[1]=1);var o=0;for(o=f(n.worth)?n.worth()/10:n.worth/10,g=0;g<this.rules.length;g++)o<0?this.rules[g][0].name!=i&&(this.rules[g][1]-=o):this.rules[g][0].name==i&&(this.rules[g][1]+=o)}},gameWorth:function(a,b){var c=0,d=0,e=0,f=this.armiesAndUnits(a,b),g=f[1],h=f[3];return h.forEach(function(a){d=a.cost(),a.isDead()&&(c+=d),e=a.size()-a.livingModels().length,c+=d*e/a.size()}),g.forEach(function(a){d=a.cost(),a.isDead()&&(c-=d),e=a.size()-a.livingModels().length,c-=d*e/a.size()}),c},"static __SERMAT__":{identifier:"DynamicScriptingPlayer",serializer:function(a){return this.serializeAsProperties(a,["name","rules"])}},shoot:function(a,b){return[new v(a.id),new y(a.id,b.id)]},assault:function(a,b){return[new v(a.id),new z(a.id,b.id)]},move:function(a,b,c){return c?[new v(a.id),b,new y(a.id,c.id)]:[new v(a.id),b,new w(a.id)]},scapeAux:function(a,b,c,d){for(var e=0;e<c.length;e++){var f=c[e],g=[];if(this.canHide(a,d,f)){for(var h=this.hideMoves(a,d,f),i=0;i<h.length;i++)if(a.terrain.distance(f.position,h[i].position)<=f.maxRange()+6)return this.move(d,h[i]);g=g.concat(h)}if(this.canRun(a,d,f)){for(var j=this.runMoves(a,d,f),k=0;k<j.length;k++)if(a.terrain.distance(f.position,j[k].position)<=f.maxRange()+6)return this.move(d,j[k]);g=g.concat(j)}if(g.length>0)return this.move(d,g[Math.floor(Math.random()*g.length)])}},scape:function(a,b,c){var d=this.mostDangerousUnits(a,b,c),e=this.scapeAux(a,b,d,c);if(e)return e;var f=(this.dangerousUnits(a,b,c),this.scapeAux(a,b,d,c));if(f)return f;console.log("no escapa cuando deberia");var g=c.getMoveActions(a);return this.moves(c,g[Math.floor(Math.random()*g.length)])},assistAux:function(a,b,c,d,e){for(var f=0;f<c.length;f++){var g,h=c[f];if(this.canBlockSight(a,d,e,h)){var i=this.blockSightMovements(a,d,e,h);g=i[Math.floor(Math.random()*i.length)]}if(this.canShoot(a,d,h,!0))return g?this.move(d,g,h):this.shoot(d,h);if(g)return this.move(d,g)}return null},assist:function(a,b,c,d){var e=this.mostDangerousUnits(a,b,d),f=this.assistAux(a,b,e,c,d);if(f)return f;var g=this.dangerousUnits(a,b,d),h=this.assistAux(a,b,g,c,d);if(h)return h;console.log("no asiste cuando deberia");var i=c.getMoveActions(a);return this.moves(c,i[Math.floor(Math.random()*i.length)])},getCloseTo:function(a,b,c){for(var d=this.interpolation(b.position,c.position),e=b.getMoveActions(a),f=[],g=0;g<e.length;g++){var h=e[g].position;d.forEach(function(a){h[0]===a[0]&&h[1]===a[1]&&f.push(e[g])})}for(var i=b.position,j=e[Math.floor(Math.random()*e.length)],k=0;k<f.length;k++){var l=f[k].position;a.terrain.distance(l,c.position)<a.terrain.distance(i,c.position)&&(i=l,j=f[k])}return this.move(b,j)},canShoot:function(a,b,c,d){if(!b.isDead()&&b.isEnabled&&!c.isDead()){var e;if(e=d?b.areaOfSight||a.terrain.areaOfSight(b,b.maxRange()+6)[0]:b.areaOfSight||a.terrain.areaOfSight(b,b.maxRange())[0],b.areaOfSight=e,a.terrain.canShoot(b,c)!=1/0)return!0}return!1},canAssault:function(a,b,c){if(!b.isDead()&&b.isEnabled&&!c.isDead()){var d=b.areaOfSight||a.terrain.areaOfSight(b,12)[0];if(b.areaOfSight=d,a.terrain.canShoot(b,c)<=12)return!0}return!1},interForX:function(a,b,c,d){for(var e=[],f=c,g=a+1;g<b;g++)e.push([parseInt(g),parseInt(f)]),f+=d;return e},interForY:function(a,b,c,d){for(var e=[],f=c,g=a+1;g<b;g++)e.push([parseInt(f),parseInt(g)]),f+=d;return e},interpolation:function(a,b){var c,d,e=0,f=a[0],g=b[0],h=a[1],i=b[1],j=Math.min(f,g),k=Math.max(f,g),l=Math.min(h,i),m=Math.max(h,i);return d=j===f?h:i,c=l===h?f:g,h===i?this.interForX(j,k,d,e):f===g?this.interForY(l,m,c,e):Math.abs(i-h)>=Math.abs(g-f)?(e=Math.abs(g-f)/Math.abs(i-h),this.interForY(l,m,c,e)):(e=Math.abs(i-h)/Math.abs(g-f),this.interForX(j,k,d,e))},blockSightMovements:function(a,b,c,d){for(var e=c.position,f=d.position,g=this.interpolation(e,f),h=[],i=b.getMoveActions(a),j=0;j<i.length;j++){var k=i[j].position;g.forEach(function(a){k[0]===a[0]&&k[1]===a[1]&&h.push(i[j])})}return h},canBlockSight:function(a,b,c,d){return this.blockSightMovements(a,b,c,d).length>0},canAssist:function M(a,b,c,d){for(var e=this.dangerousUnits(a,b,d),M=!1,f=0;f<e.length;f++){var g=e[f];if(!(this.canBlockSight(a,c,d,g)||this.canShoot(a,c,g,!0)||this.canAssault(a,c,g))){M=!1;break}M=!0}return M},canRun:function(a,b,c){var d=c.maxRange()+6;return!(b.isEnabled&&a.terrain.canShoot(c,b)<=d)},canHide:function(a,b,c){return!1},runMoves:function(a,b,c){for(var d=c.position,e=b.position,f=b.getMoveActions(a),g=f[Math.floor(Math.random()*f.length)],h=0;h<f.length;h++){var i=f[h].position;a.terrain.distance(i,d)>a.terrain.distance(e,d)&&(e=i,g=f[h])}return a.terrain.distance(c.position,e)<=c.maxRange()+6?(console.log("run y puede huir"),[g]):(console.log("run y huyo lo maximo q pudo pero igual lo alcanzan"),[g])},hideMoves:function(a,b,c){return[]},canScape:function N(a,b,c){var d=this.mostDangerousUnits(a,b,c);if(0===d.length)return!1;for(var N=!0,e=0;e<d.length;e++){var f=d[e];this.canRun(a,c,f)||this.canHide(a,c,f)||(N=!1)}return N},mostDangerousUnits:function(a,b,c){for(var d=this.livingEnemyUnits(a,b),e=[],f=0;f<d.length;f++){var g=d[f];this.canKill(a,g,c)&&e.push(g)}return e},dangerousUnits:function(a,b,c){for(var d=this.livingEnemyUnits(a,b),e=[],f=0;f<d.length;f++){var g=d[f];(this.canShoot(a,g,c,!0)||this.canAssault(a,g,c))&&e.push(g)}return e},canBeKilled:function(a,b,c){for(var d=this.armiesAndUnits(a,b)[3],e=0;e<d.length;e++)if(this.canKill(a,d[e],c))return!0;return!1},canKill:function(a,b,c){return!(b.isDead()||!b.isEnabled||c.isDead()||!this.canKillShooting(a,b,c)&&!this.canKillAssaulting(a,b,c))},canKillShooting:function(a,b,c){return!(b.isDead()||c.isDead()||!b.isEnabled||!(this.bestAttackResultShooting(a,b,c)>=100))},canKillAssaulting:function(a,b,c){return!(b.isDead()||c.isDead()||!b.isEnabled||!(this.bestAttackResultAssaulting(a,b,c)>=100))},bestAttackResult:function O(a,b,c){if(!b.isDead()&&b.isEnabled&&!c.isDead()){
var d=this.bestAttackResultShooting(a,b,c),e=this.bestAttackResultAssaulting(a,b,c),O=Math.max(d,e);return O}return 0},bestAttackResultShooting:function(a,b,c){if(!b.isDead()&&b.isEnabled&&!c.isDead()){var d=a.terrain.distance(b.position,c.position),e=b.livingModels(),f=0;e.forEach(function(a){a.equipments.forEach(function(a){a.range>=d&&(f+=a.attacks)})});var g=c.livingModels().length,h=100*f/g;return h>100&&(h=100),h}return 0},bestAttackResultAssaulting:function(a,b,c){if(!b.isDead()&&b.isEnabled&&!c.isDead()&&this.canAssault(a,b,c)){var d=0,e=b.livingModels();e.forEach(function(a){a.equipments.forEach(function(a){0===a.range&&(d+=a.attacks)})});var f=c.livingModels().length,g=100*d/f;return g>100&&(g=100),g}return 0},possibleUnits:function P(a,b){var c=this.armiesAndUnits(a,b)[1],P=[];for(var d in c)c[d].isDead()||!c[d].isEnabled||c[d].isActive||P.push(c[d]);return P},shootableUnits:function Q(a,b,c){var Q=[],d=this.livingEnemyUnits(a,b),e=c.getShootActions(a);return e.forEach(function(a){d.forEach(function(b){a.targetId===b.id&&Q.push(b)})}),Q},assaultableUnits:function R(a,b,c){var R=[],d=this.livingEnemyUnits(a,b),e=c.getAssaultActions(a);return e.forEach(function(a){d.forEach(function(b){a.targetId===b.id&&R.push(b)})}),R},shootingKillableUnits:function S(a,b,c){for(var S=[],d=this.shootableUnits(a,b,c),e=0;e<d.length;e++){var f=d[e];this.willKillShooting(a,c,f)&&S.push(f)}return S},livingEnemyUnits:function(a,b){var c=this.armiesAndUnits(a,b)[2];return c.livingUnits()},armiesAndUnits:function(a,b){var c=a.armies[b],d=c.units,e=a.opponent(b),f=a.armies[e],g=f.units;return[c,d,f,g]},wounded:function(a){return a.livingModels().length<a.size()},canWoundALot:function(a,b,c){return!(b.isDead()||!b.isEnabled||c.isDead())&&bestAttackResult(a,b,c)>=75},canWound:function(a,b,c){return!(b.isDead()||!b.isEnabled||c.isDead())&&bestAttackResult(a,b,c)>0},maxCost:function(a){return l(a).map(function(a){a.cost()}).max(0)},mostExpensiveUnit:function(a){for(var b,c=0,d=0;d<a.length;d++)a[d].cost()>c&&(b=a[d],c=b.cost());return b},cheapestUnit:function(a){for(var b,c=0,d=0;d<a.length;d++)a[d].cost()>c&&(b=a[d],c=b.cost());return b},unitForce:function(a){var b=a.livingModels(),c=0;b.forEach(function(a){a.equipments.forEach(function(a){c+=a.attacks})});var d=a.quality*c+a.defense/2+a.cost()/10;return d},unitIsStrongest:function(a,b){for(var c,d=0,e=0;e<a.length;e++)this.unitForce(a[e])>d&&(c=a[e],d=this.unitForce(c));return this.unitForce(b)===d},classification:function(a){return a.quality<=2&&a.defense<=3?"fastAttack":a.defense>=5?"heavySupport":a.size()>=5&&a.cost()<=130?"troop":a.maxRange()>=36?"sniper":""},maxRangeInUnits:function(a,b){var c=l(a).map(function(a){return a.maxRange()}).max(0);return b.maxRange()===c},easiestToKill:function(a,b){var c=l(a).map(function(a){return a.livingModels().length*a.defense}).max(0);return b.livingModels().length*b.defense===c},expectedResultShooting:function(a,b,c){if(this.canShoot(a,b,c,!0)){var d=a.terrain.distance(b.position,c.position),e=b.livingModels(),f=0;e.forEach(function(a){a.equipments.forEach(function(a){a.range>=d&&(f+=a.attacks)})});for(var g=0,h=0,i=0;i<f;i++)g=Math.floor(3+4*Math.random()),b.quality>g&&(h+=1);for(var j=0,k=0;k<h;k++)g=Math.floor(1+6*Math.random()),c.defense>g&&(j+=1);var l=h-j,m=c.livingModels().length,n=100*l/m;return n>100&&(n=100),n}return 0},expectedResultAssaulting:function(a,b,c){return 0},willKillShooting:function(a,b,c){return 100===this.expectedResultShooting(a,b,c)},willWoundALotShooting:function(a,b,c){return this.expectedResultShooting(a,b,c)>75},willWoundHalfShooting:function(a,b,c){return this.expectedResultShooting(a,b,c)>=50},willWoundShooting:function(a,b,c){return this.expectedResultShooting(a,b,c)>0},willKillAssaulting:function(a,b,c){return 100===this.expectedResultAssaulting(a,b,c)},willWoundALotAssaulting:function(a,b,c){return this.expectedResultAssaulting(a,b,c)>75},willWoundHalfAssaulting:function(a,b,c){return this.expectedResultAssaulting(a,b,c)>=50},willWoundAssaulting:function(a,b,c){return this.expectedResultAssaulting(a,b,c)>0},winning:function(a){var b=a.activePlayer(),c=a.players[0];return b===a.players[0]&&(c=a.players[1]),a.scores(b)>a.scores(c)},losingGameByUnitElimination:function(a,b){var c=a.activePlayer(),d=a.players[0];return c===a.players[0]&&(d=a.players[1]),a.scores(c)-b.cost()<a.scores(d)},winningActivation:function(a,b){if(4===a.round){var c=a.activePlayer(),d=a.players[0];c===a.players[0]&&(d=a.players[1]);var e=[],f=this.livingEnemyUnits(a,b);f.forEach(function(b){a.scores(c)>a.scores(d)-b.cost()&&e.push(b)});var g=this.possibleUnits(a,b);for(i=0;i<g.length;i++){var h=g[i];for(j=0;j<e.length;j++){var k=e[j];if(this.canKill(a,h,k)||this.canPin(a,h,k))return!0}}}return!1},canPin:function(a,b,c){if(this.canAssault(a,b,c)){var d=0,e=b.livingModels();if(e.forEach(function(a){a.equipments.forEach(function(a){0===a.range&&(d+=a.attacks)})}),d>=c.size()/2)return!0}return!1},isMelee:function(a){return!1},rule_12A:e(12,function(a,b){if(3===a.round&&!this.winning(a))for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=this.livingEnemyUnits(a,b),f=0;f<c.length;f++){var g=c[f];if(this.canBeKilled(a,b,g))for(var h=0;h<e.length;h++){var i=e[h];if(this.willWoundShooting(a,i,g))for(var j=0;j<e.length;j++){var k=e[j];if(this.willWoundShooting(a,g,k)&&g.cost()>k.cost())for(var l=0;l<d.length;l++){var m=d[l];if(m.cost()>g.cost()&&this.canAssist(a,b,g,m))return this.assist(a,b,g,m)}}}}return null}),rule_12C:e(12,function(a,b){if(3===a.round&&!this.winning(a)&&this.winningActivation(a,b))for(var c=this.possibleUnits(a,b),d=(this.armiesAndUnits(a,b)[1],this.livingEnemyUnits(a,b)),e=0;e<c.length;e++){var f=c[e];if(this.canBeKilled(a,b,f)&&this.canScape(a,b,f))for(var g=0;g<d.length;g++){var h=d[g];if(this.willWoundShooting(a,h,f))for(var i=0;i<d.length;i++){var j=d[i];if(this.willWoundHalfAssaulting(a,f,j)&&f.cost()>j.cost())return this.scape(a,b,f)}}}return null}),rule_12D:e(12,function(a,b){if(3===a.round&&!this.winning(a)&&this.winningActivation(a,b))for(var c=this.possibleUnits(a,b),d=(this.armiesAndUnits(a,b)[1],this.livingEnemyUnits(a,b)),e=0;e<c.length;e++){var f=c[e];if(this.canBeKilled(a,b,f)&&!this.canScape(a,b,f))for(var g=0;g<d.length;g++){var h=d[g];if(this.willWoundShooting(a,h,f))for(var i=0;i<d.length;i++){var j=d[i];if(this.willWoundShooting(a,f,j)&&this.canKill(a,f,j)&&f.cost()>j.cost())return this.shoot(f,j)}}}return null}),rule_11A:e(11,function(a,b){if(3===a.round&&!this.winning(a))for(var c=this.possibleUnits(a,b),d=(this.armiesAndUnits(a,b)[1],this.livingEnemyUnits(a,b)),e=0;e<c.length;e++){var f=c[e];if(this.canBeKilled(a,b,f)&&this.canScape(a,b,f))for(var g=0;g<d.length;g++){var h=d[g];if(this.willWoundShooting(a,h,f))for(var i=0;i<d.length;i++){var j=d[i];if(this.willWoundHalfAssaulting(a,f,j)&&f.cost()>j.cost())return this.scape(a,b,f)}}}return null}),rule_11B:e(11,function(a,b){if(3===a.round&&this.winning(a)&&this.winningActivation(a,b))for(var c=this.possibleUnits(a,b),d=(this.armiesAndUnits(a,b)[1],this.livingEnemyUnits(a,b)),e=0;e<c.length;e++){var f=c[e];if(this.canBeKilled(a,b,f)&&this.canScape(a,b,f))for(var g=0;g<d.length;g++){var h=d[g];if(this.willWoundShooting(a,h,f))for(var i=0;i<d.length;i++){var j=d[i];if(this.willWoundHalfAssaulting(a,f,j)&&f.cost()>j.cost())return this.scape(a,b,f)}}}return null}),rule_8A:e(8,function(a,b){if(3===a.round&&this.winning(a))for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=this.livingEnemyUnits(a,b),f=0;f<c.length;f++){var g=c[f];if(!this.canBeKilled(a,b,g))for(var h=0;h<d.length;h++){var i=d[h];if(i.cost()>g.cost()&&!this.canAssist(a,b,g,i))for(var j=0;j<e.length;j++){var k=e[j];if(this.willKillShooting(a,g,k)&&k.cost()===this.mostExpensiveUnit(e).cost())return this.shoot(g,k)}}}return null}),rule_8B:e(8,function(a,b){if(3===a.round&&this.winning(a))for(var c=this.possibleUnits(a,b),d=(this.armiesAndUnits(a,b)[1],this.livingEnemyUnits(a,b)),e=0;e<c.length;e++){var f=c[e];if(this.canBeKilled(a,b,f))for(var g=0;g<d.length;g++){var h=d[g];if(f.cost()<h.cost()&&this.canKill(a,f,h)&&this.willWoundShooting(a,f,h))for(var i=0;i<d.length;i++){var j=d[i];if(this.willWoundShooting(a,j,f))return this.shoot(f,h)}}}return null}),rule_8C:e(8,function(a,b){if(3===a.round&&this.winning(a))for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=this.livingEnemyUnits(a,b),f=0;f<c.length;f++){var g=c[f];if(this.canBeKilled(a,b,g))for(var h=0;h<d.length;h++){var i=d[h];if(g.cost()<i.cost()&&this.canAssist(a,b,g,i))for(var j=0;j<e.length;j++){var k=e[j];if(this.willWoundShooting(a,k,g))for(var l=0;l<e.length;l++){var m=e[l];if(this.willWoundShooting(a,g,m)&&g.cost()>m.cost())return this.assist(a,b,g,i)}}}}return null}),rule_7A:e(7,function(a,b){if(3===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=this.livingEnemyUnits(a,b),f=0;f<c.length;f++){var g=c[f];if(!this.canBeKilled(a,b,g))for(var h=0;h<d.length;h++){var i=d[h];if(i.cost()>g.cost())for(var j=0;j<e.length;j++){var k=e[j];if(this.easiestToKill(e,k)&&this.canWound(a,g,k))return this.shoot(g,k)}}}return null}),rule_7B:e(7,function(a,b){if(3===a.round)for(var c=this.possibleUnits(a,b),d=(this.armiesAndUnits(a,b)[1],this.livingEnemyUnits(a,b)),e=0;e<c.length;e++){var f=c[e];if(this.canBeKilled(a,b,f))for(var g=0;g<d.length;g++){var h=d[g];if(h.cost()===this.mostExpensiveUnit(d).cost()&&this.canKill(a,f,h)&&this.willWoundShooting(a,f,h))for(var i=0;i<d.length;i++){var j=d[i];if(this.willWoundShooting(a,j,f))return this.shoot(f,h)}}}return null}),rule_7C:e(7,function(a,b){if(3===a.round)for(var c=this.possibleUnits(a,b),d=(this.armiesAndUnits(a,b)[1],this.livingEnemyUnits(a,b)),e=0;e<c.length;e++){var f=c[e];if(this.canBeKilled(a,b,f))for(var g=0;g<d.length;g++){var h=d[g];if(f.cost()<h.cost()&&this.canKill(a,f,h)&&this.willWoundShooting(a,f,h))for(var i=0;i<d.length;i++){var j=d[i];if(this.willWoundShooting(a,j,f))return this.shoot(f,h)}}}return null}),rule_7D:e(7,function(a,b){if(3===a.round&&!this.winning(a))for(var c=this.possibleUnits(a,b),d=(this.armiesAndUnits(a,b)[1],this.livingEnemyUnits(a,b)),e=0;e<c.length;e++){var f=c[e];if(this.canBeKilled(a,b,f))for(var g=0;g<d.length;g++){var h=d[g];if(f.cost()<h.cost()&&this.willWoundShooting(a,f,h))for(var i=0;i<d.length;i++){var j=d[i];if(this.willWoundShooting(a,j,f))return this.shoot(f,h)}}}return null}),rule_7E:e(7,function(a,b){if(3===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=this.livingEnemyUnits(a,b),f=0;f<c.length;f++){var g=c[f];if(this.canBeKilled(a,b,g))for(var i=0;i<e.length;i++){var j=e[i];if(!this.willWoundShooting(a,g,j))for(var k=0;k<e.length;k++){var l=e[k];if(this.willWoundShooting(a,l,g))for(h=0;h<d.length;h++)if(g.cost()<unitX2.cost()&&this.canAssist(a,b,g,unitX2))return this.assist(a,b,g,unitX2)}}}return null}),rule_7F:e(7,function(a,b){if(3===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=this.livingEnemyUnits(a,b),f=0;f<c.length;f++){var g=c[f];if(this.canBeKilled(a,b,g)&&this.canScape(a,b,g))for(var i=0;i<e.length;i++){var j=e[i];if(!this.willWoundShooting(a,g,j))for(var k=0;k<e.length;k++){var l=e[k];if(this.willWoundShooting(a,l,g))for(h=0;h<d.length;h++)if(g.cost()<unitX2.cost()&&!this.canAssist(a,b,g,unitX2))return this.scape(a,b,g)}}}return null}),rule_6A:e(6,function(a,b){if(3===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++){var e=c[d],f=this.shootingKillableUnits(a,b,e);if(!this.canBeKilled(a,b,e))for(var g=0;g<f.length;g++){var h=f[g];if(h.cost()===this.mostExpensiveUnit(f).cost())return this.shoot(e,h)}}return null}),rule_6B:e(6,function(a,b){if(3===a.round)for(var c=this.possibleUnits(a,b),d=this.livingEnemyUnits(a,b),e=0;e<c.length;e++){var f=c[e],g=this.shootingKillableUnits(a,b,f);if(this.canBeKilled(a,b,f))for(var h=0;h<d.length;h++){var i=d[h];if(this.willWoundShooting(a,i,f))for(var j=0;j<g.length;j++){var k=g[j];if(f.cost()>k.cost()&&this.willWoundShooting(a,f,k))return this.shoot(f,i)}}}return null}),rule_6C:e(6,function(a,b){if(3===a.round)for(var c=this.possibleUnits(a,b),d=this.livingEnemyUnits(a,b),e=0;e<c.length;e++){var f=c[e];if(this.canBeKilled(a,b,f))for(var g=0;g<d.length;g++){var h=d[g];if(this.willWoundShooting(a,h,f)&&this.canScape(a,b,f))return this.scape(a,b,f)}}return null}),rule_5A:e(5,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.canKillShooting(a,e,h)&&this.willWoundALotShooting(a,e,h))return this.shoot(e,h)}return null}),rule_5B:e(5,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.canKillShooting(a,e,h)&&this.willWoundALotShooting(a,e,h))return this.shoot(e,h)}return null}),rule_5C:e(5,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.canKillShooting(a,e,h)&&this.willWoundALotShooting(a,e,h))return this.shoot(e,h)}return null}),rule_5D:e(5,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.canKill(a,h,e)&&this.willWoundShooting(a,e,h))return this.shoot(e,h)}return null}),rule_5E:e(5,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.canKill(a,h,e)&&this.willWoundShooting(a,e,h))return this.shoot(e,h)}return null}),rule_5F:e(5,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.canKill(a,h,e)&&this.canScape(a,b,e))return this.scape(a,b,e)}return null}),rule_5G:e(5,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.canKill(a,h,e)&&this.canScape(a,b,e))return this.scape(a,b,e)}return null}),rule_4A:e(4,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.canKillShooting(a,e,h))return this.shoot(e,h)}return null}),rule_4B:e(4,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.canKillShooting(a,e,h))return this.shoot(e,h)}return null}),rule_4C:e(4,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.canKillShooting(a,e,h))return this.shoot(e,h)}return null}),rule_4D:e(4,function(a,b){if(3===a.round&&this.winning(a))for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if(!this.canBeKilled(a,b,f))for(var g=0;g<d.length;g++){var h=d[g];if(h.cost()>f.cost()&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_4E:e(4,function(a,b){if(3===a.round&&this.winning(a))for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if(!this.canBeKilled(a,b,f))for(var g=this.shootableUnits(a,b,f),h=0;h<g.length;h++){var i=g[h];if(this.canWound(a,f,i)&&this.easiestToKill(g,i))for(var j=0;j<d.length;j++){var k=d[j];if(k.cost()>f.cost()&&!this.canAssist(a,b,f,k))return this.shoot(f,i)}}}return null}),rule_3A:e(3,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if("sniper"===this.classification(e)&&this.unitIsStrongest(f,h))return this.shoot(e,h)}return null}),rule_3B:e(3,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.maxRangeInUnits(c,e)&&this.unitIsStrongest(f,h))return this.shoot(e,h)}return null}),rule_3C:e(3,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++)for(var f=c[e],g=0;g<d.length;g++){var h=d[g];if(this.wounded(h)&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}return null}),rule_3D:e(3,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++)for(var f=c[e],g=0;g<d.length;g++){var h=d[g];if(this.wounded(h)&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}return null}),rule_3E:e(3,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++)for(var f=c[e],g=0;g<d.length;g++){var h=d[g];if(this.wounded(h)&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}return null}),rule_3F:e(3,function(a,b){if(3===a.round)for(var c=this.possibleUnits(a,b),d=this.livingEnemyUnits(a,b),e=this.armiesAndUnits(a,b)[1],f=0;f<c.length;f++)for(var g=c[f],h=0;h<e.length;h++){var i=e[h];if(i.cost()>g.cost()&&this.canAssist(a,b,g,i))for(var j=0;j<d.length;j++){var k=d[j];if(!this.canKill(a,k,g))return this.assist(a,b,g,i)}}return null}),rule_3G:e(3,function(a,b){var c=this.possibleUnits(a,b);if(0===a.round)for(var d=0;d<c.length;d++){var e=c[d],f=this.shootableUnits(a,b,e);if(f.length>1)for(var g=0;g<f.length;g++){var h=f[g];if(h.cost()===this.mostExpensiveUnit(f).cost())return this.shoot(e,h)}}return null}),rule_3H:e(3,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++)for(var f=c[e],g=0;g<d.length;g++){var h=d[g];if(h.livingModels().length<h.size()&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}return null}),rule_3I:e(3,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++)for(var f=c[e],g=0;g<d.length;g++){var h=d[g];if(h.livingModels().length<h.size()&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}return null}),rule_3J:e(3,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++)for(var f=c[e],g=0;g<d.length;g++){var h=d[g];if(h.livingModels().length<h.size()&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}return null}),rule_3K:e(3,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.canShoot(a,e,h,!1)&&this.unitIsStrongest(f,h))return this.shoot(e,h)}return null}),rule_3L:e(3,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1].concat(this.armiesAndUnits[3]),e=0;e<c.length;e++)for(var f=c[e],g=this.shootableUnits(a,b,f),h=0;h<g.length;h++){var i=g[h];if(this.willWoundShooting(a,f,i)&&this.unitIsStrongest(d,i))return this.shoot(f,i)}return null}),rule_3M:e(3,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.willWoundShooting(a,e,h)&&this.unitIsStrongest(f,h))return this.shoot(e,h)}return null}),rule_3N:e(3,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1].concat(this.armiesAndUnits(a,b)[3]),e=0;e<c.length;e++)for(var f=c[e],g=this.shootableUnits(a,b,f),h=0;h<g.length;h++){var i=g[h];if(this.willWoundShooting(a,f,i)&&this.unitIsStrongest(d,i))return this.shoot(f,i)}return null}),rule_3O:e(3,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.willWoundShooting(a,e,h)&&this.unitIsStrongest(f,h))return this.shoot(e,h)}return null}),rule_3P:e(3,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.willWoundShooting(a,e,h)&&this.easiestToKill(f,h))return this.shoot(e,h)}return null}),rule_3Q:e(3,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++){var e=c[d];if("troop"===this.classification(e))for(var f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];if(this.willWoundShooting(a,e,h)&&this.unitIsStrongest(f,h))return this.shoot(e,h)}}return null}),rule_3R:e(3,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if(f.cost()===this.cheapestUnit(d).cost())for(var g=this.shootableUnits(a,b,f),h=0;h<g.length;h++){var i=g[h];if(this.willWoundShooting(a,f,i)&&this.unitIsStrongest(g,i))return this.shoot(f,i)}}return null}),rule_3S:e(3,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1].concat(this.armiesAndUnits(a,b)[3]),e=0;e<c.length;e++){var f=c[e];if("troop"===this.classification(f))for(var g=this.shootableUnits(a,b,f),h=0;h<g.length;h++){var i=g[h];if(this.willWoundShooting(a,f,i)&&this.unitIsStrongest(d,i))return this.shoot(f,i)}}return null}),rule_3T:e(3,function(a,b){for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b),e=d[1],f=e.concat(d[3]),g=0;g<c.length;g++)for(var h=c[g],i=0;i<e.length;i++){var j=e[i];if(this.wounded(j)&&this.canAssist(a,b,h,j))for(var k=this.shootableUnits(a,b,h),l=0;l<k.length;l++){var m=k[l];if(this.willWoundShooting(a,h,m)&&this.unitIsStrongest(f,m))return this.assist(a,b,h,j)}}return null}),rule_2B:e(2,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++){var e=c[d];if("fastAttack"===this.classification(e))for(var f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];return this.shoot(e,h)}}return null}),rule_2C:e(2,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++){var e=c[d];if("fastAttack"===this.classification(e))for(var f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];return this.shoot(e,h)}}return null}),rule_2D:e(2,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++){var e=c[d];if("fastAttack"===this.classification(e))for(var f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];return this.shoot(e,h)}}return null}),rule_2E:e(2,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if("heavySupport"===this.classification(f))for(var g=0;g<d.length;g++){var h=d[g];if(!h.isEnabled&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_2F:e(2,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if("heavySupport"===this.classification(f))for(var g=0;g<d.length;g++){var h=d[g];if(this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_2G:e(2,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if("heavySupport"===this.classification(f))for(var g=0;g<d.length;g++){var h=d[g];if(!h.isEnabled&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_2H:e(2,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if("heavySupport"===this.classification(f))for(var g=0;g<d.length;g++){var h=d[g];if(this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_2I:e(2,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if("heavySupport"===this.classification(f))for(var g=0;g<d.length;g++){var h=d[g];if(!h.isEnabled&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_2J:e(2,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if("heavySupport"===this.classification(f))for(var g=0;g<d.length;g++){var h=d[g];if(this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_2K:e(2,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if("troop"===this.classification(f))for(var g=0;g<d.length;g++){var h=d[g];if(!h.isEnabled&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_2L:e(2,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if("troop"===this.classification(f))for(var g=0;g<d.length;g++){var h=d[g];if(this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_2M:e(2,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if("troop"===this.classification(f))for(var g=0;g<d.length;g++){var h=d[g];if(!h.isEnabled&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_2N:e(1,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if("troop"===this.classification(f))for(var g=0;g<d.length;g++){var h=d[g];if(this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_2O:e(2,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if("troop"===this.classification(f))for(var g=0;g<d.length;g++){var h=d[g];if(!h.isEnabled&&this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_2P:e(2,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=this.armiesAndUnits(a,b)[1],e=0;e<c.length;e++){var f=c[e];if("troop"===this.classification(f))for(var g=0;g<d.length;g++){var h=d[g];if(this.canAssist(a,b,f,h))return this.assist(a,b,f,h)}}return null}),rule_2Q:e(2,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++){var e=c[d];if("sniper"===this.classification(e))for(var f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];return this.shoot(e,h)}}return null}),rule_2R:e(2,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++){var e=c[d];if("sniper"===this.classification(e))for(var f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];return this.shoot(e,h)}}return null}),rule_2S:e(2,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++){var e=c[d];if("sniper"===this.classification(e))for(var f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];return this.shoot(e,h)}}return null}),rule_1A:e(1,function(a,b){if(0===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++){var e=c[d];if(this.canScape(a,b,e))return this.scape(a,b,e)}return null}),rule_1B:e(1,function(a,b){if(1===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++){var e=c[d];if(this.canScape(a,b,e))return this.scape(a,b,e)}return null}),rule_1C:e(1,function(a,b){if(2===a.round)for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];return this.shoot(e,h)}return null}),rule_1E:e(1,function(a,b){for(var c=this.possibleUnits(a,b),d=0;d<c.length;d++)for(var e=c[d],f=this.shootableUnits(a,b,e),g=0;g<f.length;g++){var h=f[g];return this.shoot(e,h)}return null}),rule_1F:e(1,function(a,b){for(var c=this.livingEnemyUnits(a,b),d=this.possibleUnits(a,b),e=0;e<d.length;e++){var f=d[e];if(0==this.shootableUnits(a,b,f).length)for(var g=0;g<c.length;g++){var h=c[g];if(this.easiestToKill(c,h))return this.getCloseTo(a,f,h)}}return null})});q.Renderer=k({constructor:function(a){a=this.canvas=a||document.getElementById("wargame-canvas");var b=this.ctx=a.getContext("2d");b.fillStyle="white"},renderScope:function(a,b,c){var d=this.canvas,e=this.ctx;e.save(),e.scale(d.width/a,d.height/b);try{c.call(this,e)}finally{e.restore()}},render:function(a){var b=a.terrain;this.renderScope(b.width,b.height,function(c){c.clearRect(0,0,this.canvas.width,this.canvas.height);for(var d=0,e=b.width;d<e;d++)for(var f=0,g=b.height;f<g;f++)b.isPassable([d,f])?this.drawSquare(d,f,1,1,"#CCCCCC"):this.drawSquare(d,f,1,1,"black");var h=this,i=a.armies;c.strokeStyle="black",c.font="1px Arial";for(var j in i)i[j].units.forEach(function(a){a.isDead()||(h.drawSquare(a.position[0],a.position[1],1,1,a.army.player),c.fillStyle="black",c.fillText(a.id,a.position[0],a.position[1]))})})},renderPath:function(a,b,c){var d=a.terrain;this.renderScope(d.width,d.height,function(e){e.clearRect(0,0,this.canvas.width,this.canvas.height);for(var f=0,g=d.width;f<g;f++)for(var h=0,i=d.height;h<i;h++)d.isPassable([f,h])?this.drawSquare(f,h,1,1,"#CCCCCC"):this.drawSquare(f,h,1,1,"black");var j=this,k=a.armies;e.strokeStyle="black",e.font="1px Arial";for(var l in k)k[l].units.forEach(function(a){a.isDead()||(j.drawSquare(a.position[0],a.position[1],1,1,a.army.player),e.fillStyle="black",e.fillText(a.id,a.position[0],a.position[1]))});for(var m in b)j.drawSquare(b[m].x,b[m].y,1,1,c||"red")})},renderSight:function(a,b){if(b=b||a.__activeUnit__){var c=a.terrain;this.renderScope(c.width,c.height,function(a){var d,e,f=b.maxRange(),g=c.areaOfSight(b,f);for(var h in g)d=.8*(1-g[h]/f)+.2,e=h.split(","),this.drawSquare(+e[0],+e[1],1,1,"rgba(255,255,0,"+d+")")})}},renderMoves:function(a,b){var c=this.canvas,d=this.ctx,e=a.terrain;e.world;this.render(a),d.save(),d.scale(c.width/e.WorldWidth,c.height/e.WorldHeight);for(var f in b)b[f].forEach(function(a){a.constructor==x&&(d.save(),d.fillStyle="#32CD32",d.beginPath(),d.arc(a.position[0],a.position[1],1,0,2*Math.PI),d.fill(),d.restore())});d.restore()},drawSquare:function(a,b,c,d,e){var f=this.ctx;f.fillStyle=e,f.fillRect(a,b,1,1)},renderInfluence:function(a,b){var c=a.terrain;this.renderScope(c.width,c.height,function(c){var d,e,f,g,h,i=b.length,j=b[0].length,k=(this.canvas,a.terrain),l=(k.world,Number.POSITIVE_INFINITY),m=Number.NEGATIVE_INFINITY,n=k.width,o=k.height;for(c.clearRect(0,0,this.canvas.width,this.canvas.height),g=0,n;g<n;g++)for(h=0,o;h<o;h++)k.isPassable([g,h])?this.drawSquare(g,h,1,1,"#CCCCCC"):this.drawSquare(g,h,1,1,"black");for(g=0;g<i;g++)for(h=0;h<j;h++)isNaN(b[g][h])||(m=Math.max(m,b[g][h]),l=Math.min(l,b[g][h]));for(e=Math.max(m,Math.abs(l)),g=0;g<i;g++)for(h=0;h<j;h++)d=b[g][h],"t"==d?this.drawSquare(g,h,1,1,"black"):d>0?(f=d/e,this.drawSquare(g,h,1,1,"rgba(255,0,0,"+f+")")):d<0&&(f=-d/e,this.drawSquare(g,h,1,1,"rgba(0,0,255,"+f+")"))})}});var H=q.StrategicAttackAction=k(u,{constructor:function(a,b){this.unitId=a,this.targetId=b},executeMovement:function(a,b,c){var d=a.activePlayer(),e=this.unitById(a,this.unitId),f=this.unitById(a,this.targetId),h=b.shootPositions,i=(b.assaultPositions,b.movePositions);return h.length>0?(h.sort(function(a,b){return b.influence-a.influence}),a=a.next(p(d,new x(e.id,h[0].position,(!1))),null,c),a=a.next(p(d,new y(e.id,f.id))),a.isContingent&&(a=a.randomNext())):a=a.next(p(d,new x(e.id,i[i.length-1].position,(!0))),null,c),a.__activeUnit__&&g.__activeUnit__.id===attack.unitId&&(a=a.next(p(d,new w(e.id)),null,c)),a},synchronizeMetagame:function(){this.terrain.resetTerrain(this)},strategicPositions:function(a,b,c){var d,e=a,f=this.unitById(e,this.unitId),g=this.unitById(e,this.targetId),h=e.activePlayer(),i={movePositions:[],shootPositions:[],assaultPositions:[]};b?(d=e.terrain.canReachAStarInf({target:g,attacker:f,influenceMap:b,role:h}),RENDERER.renderInfluence(e,b)):d=e.terrain.canReachAStar({target:g,attacker:f}),d.unshift({x:f.position[0],y:f.position[1]});for(var j=0;j<d.length;j++){var k=d[j],l=c[k.x+","+k.y],m=this.getInf([k.x,k.y],h,b),n=j<=6&&void 0!==l,o=l<=2,p=j<=12;g.position[0]==k.x&&g.position[1]==k.y||(n?i.shootPositions.push({position:[k.x,k.y],influence:m,shootDistance:l}):p?i.movePositions.push({position:[k.x,k.y],influence:m,shootDistance:l}):o&&i.assaultPositions.push({position:[k.x,k.y],influence:m,shootDistance:l}))}return i},getInf:function(a,b,c){var d=a[0],e=a[1];return"Red"==b?c[d][e]:-c[d][e]},execute:function(a,b){a.concreteGame.synchronizeMetagame();var c=a.concreteGame,d=this.unitById(c,this.unitId),e=this.unitById(c,this.targetId),f=c.activePlayer(),g=c.terrain.areaOfSight(e,d.maxRange()),h=this.strategicPositions(c,a.concreteInfluence,g);
return c.result()?null:(c=c.next(p(f,new v(this.unitId)),null,b),c=this.executeMovement(c,h,b),o(!(c instanceof E),"Executing action ",this," did not yield a Wargame instance!"),a.concreteGame=c,a)},"static __SERMAT__":{identifier:"StrategicAttackAction",serializer:function(a){return[a.unitId,a.targetId]}},toString:function(){return c.ser(this)}}),I=q.AbstractedWargame=k(d.Game,{constructor:function(a){o(!(a instanceof E),"Invalid concrete wargame ",a,"!"),this.players=a.players,d.Game.call(this,a.activePlayer()),this.concreteGame=a,this.influenceMap=new ludorum_wargame.InfluenceMap(a),this.concreteInfluence=this.influenceMap.update(a)},result:function(){return this.concreteGame.result()},moves:function(){if(this.result())return null;var a=this.concreteGame,b=this.activePlayer(),c={};return c[b]=m.product(a.armies[b].units.filter(function(b){return!b.isDead(a)&&b.isEnabled}),a.armies[a.opponent()].units.filter(function(a){return!a.isDead()})).mapApply(function(a,b){return new H(a.id,b.id)}).toArray(),c},next:function(a,b,d){var e=d?this:c.clone(this),f=this.activePlayer(),g=a[f];return g.execute(e,d),e.activePlayers=e.concreteGame.activePlayers,e.concreteInfluence=e.influenceMap.update(e.concreteGame,1),e},"static __SERMAT__":{identifier:"AbstractedWargame",serializer:function(a){return[a.concreteGame]}}}),J=q.astar=k({pathTo:function(a){for(var b=a,c=[];b.parent;)c.unshift(b),b=b.parent;return c},getHeap:function(){return new L(function(a){return a.f})},search:function(a,b,c,d){a.cleanDirty(),d=d||{};var e=d.heuristic||this.heuristics.manhattan,f=d.closest||!1,g=this.getHeap(),h=d.exitCondition,i=b;for(b.h=e(b,c,d.influenceMap,d.role),a.markDirty(b),g.push(b);g.size()>0;){var j=g.pop();if(j===c||h&&h[j.x+","+j.y])return this.pathTo(j);j.closed=!0;for(var k=a.neighbors(j),l=0,m=k.length;l<m;++l){var n=k[l];if(!n.closed&&!n.isWall()){var o=j.g+n.getCost(j),p=n.visited;(!p||o<n.g)&&(n.visited=!0,n.parent=j,n.h=n.h||e(n,c,d.influenceMap),n.g=o,n.f=n.g+n.h,a.markDirty(n),f&&(n.h<i.h||n.h===i.h&&n.g<i.g)&&(i=n),p?g.rescoreElement(n):g.push(n))}}}return f?this.pathTo(i):[]},heuristics:{manhattan:function(a,b){var c=Math.abs(b.x-a.x),d=Math.abs(b.y-a.y);return c+d},diagonal:function(a,b){var c=1,d=Math.sqrt(2),e=Math.abs(b.x-a.x),f=Math.abs(b.y-a.y);return c*(e+f)+(d-2*c)*Math.min(e,f)}},cleanNode:function(a){a.f=0,a.g=0,a.h=0,a.visited=!1,a.closed=!1,a.parent=null}}),K=(q.Graph=k({constructor:function(a,b){b=b||{},this.nodes=[],this.diagonal=!!b.diagonal,this.grid=[],this.astar=new J;var c,d,e,f,g,h;for(d=0;d<a.width;d++)for(this.grid[d]=[],e=0;e<a.height;e++)g=b.start[0]==d&&b.start[1]==e,g=b.end[0]==d&&b.end[1]==e,f=(a.isPassable([d,e],!0)||g||h)===!0?1:0,c=new K(d,e,f),this.grid[d][e]=c,this.nodes.push(c);this.init()},init:function(){this.dirtyNodes=[];for(var a=0;a<this.nodes.length;a++)this.astar.cleanNode(this.nodes[a])},cleanDirty:function(){for(var a=0;a<this.dirtyNodes.length;a++)this.astar.cleanNode(this.dirtyNodes[a]);this.dirtyNodes=[]},markDirty:function(a){this.dirtyNodes.push(a)},neighbors:function(a){var b=[],c=a.x,d=a.y,e=this.grid;return e[c-1]&&e[c-1][d]&&b.push(e[c-1][d]),e[c+1]&&e[c+1][d]&&b.push(e[c+1][d]),e[c]&&e[c][d-1]&&b.push(e[c][d-1]),e[c]&&e[c][d+1]&&b.push(e[c][d+1]),this.diagonal&&(e[c-1]&&e[c-1][d-1]&&b.push(e[c-1][d-1]),e[c+1]&&e[c+1][d-1]&&b.push(e[c+1][d-1]),e[c-1]&&e[c-1][d+1]&&b.push(e[c-1][d+1]),e[c+1]&&e[c+1][d+1]&&b.push(e[c+1][d+1])),b},toString:function(){for(var a=[],b=this.grid,c=0;c<b.length;c++){for(var d=[],e=b[c],f=0;f<e.length;f++)d.push(e[f].weight);a.push(d.join(" "))}return a.join("\n")}}),q.GridNode=k({constructor:function(a,b,c){this.x=a,this.y=b,this.weight=c},toString:function(){return"["+this.x+" "+this.y+"]"},getCost:function(a){return a&&a.x!=this.x&&a.y!=this.y?1.41421*this.weight:this.weight},isWall:function(){return 0===this.weight}})),L=q.BinaryHeap=k({constructor:function(a){this.content=[],this.scoreFunction=a},push:function(a){this.content.push(a),this.sinkDown(this.content.length-1)},pop:function(){var a=this.content[0],b=this.content.pop();return this.content.length>0&&(this.content[0]=b,this.bubbleUp(0)),a},remove:function(a){var b=this.content.indexOf(a),c=this.content.pop();b!==this.content.length-1&&(this.content[b]=c,this.scoreFunction(c)<this.scoreFunction(a)?this.sinkDown(b):this.bubbleUp(b))},size:function(){return this.content.length},rescoreElement:function(a){this.sinkDown(this.content.indexOf(a))},sinkDown:function(a){for(var b=this.content[a];a>0;){var c=(a+1>>1)-1,d=this.content[c];if(!(this.scoreFunction(b)<this.scoreFunction(d)))break;this.content[c]=b,this.content[a]=d,a=c}},bubbleUp:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e,f=a+1<<1,g=f-1,h=null;if(g<b){var i=this.content[g];e=this.scoreFunction(i),e<d&&(h=g)}if(f<b){var j=this.content[f],k=this.scoreFunction(j);k<(null===h?d:e)&&(h=f)}if(null===h)break;this.content[a]=this.content[h],this.content[h]=c,a=h}}});return[].forEach(function(a){a.__SERMAT__.identifier=q.__package__+"."+a.__SERMAT__.identifier,q.__SERMAT__.include.push(a)}),c.include(q),q});
//# sourceMappingURL=ludorum-wargame.min.js.map